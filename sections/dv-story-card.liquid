{% comment %}
  DinVeda Story Card Section (DV Template)
  Displays the product story with title, content, and optional traditional benefits.
  
  Content Source:
  - Priority: Product metafields (custom.dv_story_title, custom.dv_story_content)
  - Fallback: Section settings in theme editor
  
  IMPORTANT - Content Entry in Shopify Admin:
  - custom.dv_story_title: Single line text field (plain text)
  - custom.dv_story_content: Rich text field - MUST use the richtext editor interface
    Do NOT paste raw HTML code into this field. Use the formatting toolbar to create
    paragraphs, bold text, lists, etc. The richtext editor will store the content
    in the correct format for rendering.
  - custom.dv_traditional_benefits: Multi-line text field (plain text, one bullet per line)
{% endcomment %}

{%- liquid
  # Read from metafields (priority) or section settings (fallback)
  assign story_title = product.metafields.custom.dv_story_title
  if story_title == blank
    assign story_title = section.settings.title
  endif
  
  # Read richtext metafield - must be stored as richtext type in Shopify Admin
  # Use metafield_tag filter to properly render richtext content
  assign story_content_metafield = product.metafields.custom.dv_story_content
  
  assign traditional_bullets = product.metafields.custom.dv_traditional_benefits
  
  # Parse traditional benefits bullets (if available)
  assign bullets_array = '' | split: ','
  if traditional_bullets != blank
    assign bullets_raw = traditional_bullets | newline_to_br | split: '<br />'
    assign item_count = 0
    for line in bullets_raw
      if item_count < 5
        assign trimmed_line = line | strip
        if trimmed_line != blank
          assign clean_line = trimmed_line | replace: '• ', '' | replace: '•', '' | replace: '- ', '' | strip
          if clean_line != blank
            assign bullets_array = bullets_array | push: clean_line
            assign item_count = item_count | plus: 1
          endif
        endif
      endif
    endfor
  endif
  
  # Check if we have content to show
  assign has_content = false
  if story_title != blank or story_content_metafield != blank or section.settings.content != blank or bullets_array.size > 0
    assign has_content = true
  endif
-%}

{% if has_content or section.settings.show_when_empty %}
<section
  id="dv-story-card-{{ section.id }}"
  class="dv-story-card"
  data-section-id="{{ section.id }}"
  data-section-type="dv-story-card"
>
  {% style %}
    #dv-story-card-{{ section.id }} {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
      background-color: {{ section.settings.background_color | default: '#f3e9dc' }};
    }
  {% endstyle %}
  
  <div class="dv-story-card__container">
    <div class="dv-story-card__content">
      
      {%- comment -%} Story Title with Icon {%- endcomment -%}
      {% if story_title != blank %}
        <h2 class="dv-story-card__title">
          {% if section.settings.show_fox_icon and section.settings.fox_icon != blank %}
            <img src="{{ section.settings.fox_icon | image_url: width: 40 }}" alt="" class="dv-story-card__title-icon" width="40" height="40">
          {% endif %}
          {{ story_title | escape }}
        </h2>
      {% endif %}
      
      {%- comment -%} Story Content 
        Uses metafield_tag filter for richtext metafields - this properly renders
        formatted content stored in Shopify's richtext format. If HTML tags are
        visible as text, the content was likely pasted as raw HTML instead of
        being formatted through the richtext editor in Shopify Admin.
      {% endcomment -%}
      {% if story_content_metafield != blank %}
        <div class="dv-story-card__body rte">
          {{ story_content_metafield | metafield_tag }}
        </div>
      {% elsif section.settings.content != blank %}
        <div class="dv-story-card__body rte">
          {{ section.settings.content }}
        </div>
      {% endif %}

      {%- comment -%} Traditional Benefits Bullets {%- endcomment -%}
      {% if bullets_array.size > 0 %}
        <div class="dv-story-card__traditional-benefits">
          <h3 class="dv-story-card__traditional-heading">Traditionell geschätzt für …</h3>
          <ul class="dv-story-card__bullet-list">
            {% for bullet in bullets_array %}
              <li>{{ bullet | escape }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      {%- comment -%} Disclaimer {%- endcomment -%}
      {% if section.settings.show_disclaimer %}
        <p class="dv-story-card__disclaimer">
          {{ section.settings.disclaimer_text | default: 'AYURVEDISCH INSPIRIERTE GENUSS-TRADITION. KEIN HEILVERSPRECHEN.' | escape }}
        </p>
      {% endif %}

    </div>
  </div>
</section>
{% endif %}

{% schema %}
{
  "name": "DV Story Card",
  "tag": "section",
  "class": "dynamic-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Story Title",
      "default": "Warum der Fuchs?",
      "info": "Used if product.metafields.custom.dv_story_title is empty"
    },
    {
      "type": "richtext",
      "id": "content",
      "label": "Story Content",
      "info": "Used if product.metafields.custom.dv_story_content is empty"
    },
    {
      "type": "checkbox",
      "id": "show_when_empty",
      "label": "Show section even if all markers are empty",
      "default": false
    },
    {
      "type": "header",
      "content": "Icon"
    },
    {
      "type": "checkbox",
      "id": "show_fox_icon",
      "label": "Show fox icon",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "fox_icon",
      "label": "Fox icon image",
      "info": "Icon to display next to story title"
    },
    {
      "type": "header",
      "content": "Disclaimer"
    },
    {
      "type": "checkbox",
      "id": "show_disclaimer",
      "label": "Show disclaimer",
      "default": true
    },
    {
      "type": "text",
      "id": "disclaimer_text",
      "label": "Disclaimer text",
      "default": "AYURVEDISCH INSPIRIERTE GENUSS-TRADITION. KEIN HEILVERSPRECHEN."
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#f3e9dc"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 120,
      "step": 8,
      "unit": "px",
      "default": 80
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 120,
      "step": 8,
      "unit": "px",
      "default": 80
    }
  ]
}
{% endschema %}

