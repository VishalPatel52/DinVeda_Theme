{% comment %}
  DinVeda Story Card Section (DV Template)
  Displays the product story with title, content, and optional traditional benefits.
  
  Content Source:
  - Priority: Product metafields (custom.dv_story_title, custom.dv_story_content)
  - Fallback: Section settings in theme editor
  
  IMPORTANT - Content Entry in Shopify Admin:
  - custom.dv_story_title: Single line text field (plain text)
  - custom.dv_story_content: Rich text field - MUST use the richtext editor interface
    Do NOT paste raw HTML code into this field. Use the formatting toolbar to create
    paragraphs, bold text, lists, etc. The richtext editor will store the content
    in the correct format for rendering.
  - custom.dv_traditional_benefits: Multi-line text field (plain text, one bullet per line)
{% endcomment %}

{%- liquid
  # Read from theme editor settings (can be connected to metafields via dynamic source)
  assign story_title = section.settings.title
  assign animal_name = section.settings.animal_name
  assign story_content_metafield = section.settings.content
  
  # Auto-generate title from animal name if story_title is empty
  if story_title == blank and animal_name != blank
    assign story_title = 'Warum der ' | append: animal_name | append: '?'
  endif
  
  # Traditional benefits from settings (can be connected to metafield)
  assign traditional_bullets = section.settings.traditional_benefits
  
  # Icon size from settings (default 140px)
  assign icon_size = section.settings.icon_size | default: 140
  
  # Animal image: Priority from product metafield, fallback to section setting
  assign animal_image = null
  if product and product.metafields.custom.dv_animal_image
    assign metafield_file = product.metafields.custom.dv_animal_image.value
    if metafield_file and metafield_file != blank
      assign animal_image = metafield_file
    endif
  endif
  if animal_image == null and section.settings.fox_icon != blank
    assign animal_image = section.settings.fox_icon
  endif
  
  # Check for checklist items from blocks (priority) or metafields (fallback)
  assign has_checklist_blocks = false
  assign checklist_items_count = 0
  if section.blocks.size > 0
    for block in section.blocks
      if block.type == 'checklist_item'
        assign has_checklist_blocks = true
        assign checklist_items_count = checklist_items_count | plus: 1
      endif
    endfor
  endif
  
  # Parse traditional benefits if no blocks and setting is provided
  assign bullets_array = '' | split: ','
  if has_checklist_blocks == false and traditional_bullets != blank
    assign bullets_raw = traditional_bullets | newline_to_br | split: '<br />'
    assign item_count = 0
    for line in bullets_raw
      if item_count < 5
        assign trimmed_line = line | strip
        if trimmed_line != blank
          assign clean_line = trimmed_line | replace: '• ', '' | replace: '•', '' | replace: '- ', '' | strip
          if clean_line != blank
            assign bullets_array = bullets_array | push: clean_line
            assign item_count = item_count | plus: 1
          endif
        endif
      endif
    endfor
  endif
  
  # Check if we have content to show
  assign has_content = false
  if story_title != blank or story_content_metafield != blank or section.settings.content != blank or has_checklist_blocks or bullets_array.size > 0
    assign has_content = true
  endif
-%}

{% if has_content or section.settings.show_when_empty %}
<section
  id="dv-story-card-{{ section.id }}"
  class="dv-story-card"
  data-section-id="{{ section.id }}"
  data-section-type="dv-story-card"
>
  {% style %}
    #dv-story-card-{{ section.id }} {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
      background-color: {{ section.settings.background_color | default: '#f3e9dc' }};
    }
  {% endstyle %}
  
  <div class="dv-story-card__container">
    <div class="dv-story-card__layout">
      {%- comment -%} Centered Icon (Editorial Focal Point) {%- endcomment -%}
      {% if section.settings.show_fox_icon and animal_image != blank %}
        <div class="dv-story-card__icon-wrapper" style="width: {{ icon_size }}px; height: {{ icon_size }}px;">
          {%- assign animal_alt_text = animal_name | default: 'Animal icon' | escape -%}
          {%- assign image_width = icon_size | times: 2 -%}
          {{ animal_image | image_url: width: image_width | image_tag: alt: animal_alt_text, class: 'dv-story-card__icon', loading: 'lazy', width: icon_size, height: icon_size }}
        </div>
      {% endif %}

      {%- comment -%} Centered Title (Italic, Editorial) {%- endcomment -%}
      {% if story_title != blank %}
        <h2 class="dv-story-card__title">
          {{ story_title | escape }}
        </h2>
      {% endif %}

      {%- comment -%} Story Content - Personal Letter Format (Brief vom Fuchs)
        Uses metafield_tag filter for richtext metafields - this properly renders
        formatted content stored in Shopify's richtext format. If HTML tags are
        visible as text, the content was likely pasted as raw HTML instead of
        being formatted through the richtext editor in Shopify Admin.
      {% endcomment -%}
      {% if story_content_metafield != blank %}
        <div class="dv-story-card__body rte">
          {{ story_content_metafield }}
        </div>
      {% endif %}

      {%- comment -%} Handwritten-style Signature (at bottom for emotional resonance) {%- endcomment -%}
      {% if animal_name != blank %}
        <div class="dv-story-card__signature">
          {{ animal_name | escape }}
        </div>
      {% endif %}

      {%- comment -%} Traditional Benefits Checklist (optional, below signature) {%- endcomment -%}
      {% if has_checklist_blocks or bullets_array.size > 0 %}
        <div class="dv-story-card__traditional-benefits">
          <h3 class="dv-story-card__traditional-heading">
            {{ section.settings.checklist_heading | default: 'Traditionell geschätzt für …' | escape }}
          </h3>
          <ul class="dv-story-card__bullet-list">
            {%- comment -%} Use blocks if available {%- endcomment -%}
            {% if has_checklist_blocks %}
              {% for block in section.blocks %}
                {% if block.type == 'checklist_item' and block.settings.text != blank %}
                  <li {{ block.shopify_attributes }}>
                    <div class="dv-story-card__checkmark-wrapper">
                      <svg class="dv-story-card__checkmark" width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <span class="dv-story-card__bullet-text">{{ block.settings.text | escape }}</span>
                  </li>
                {% endif %}
              {% endfor %}
            {%- comment -%} Fallback to metafields {%- endcomment -%}
            {% else %}
              {% for bullet in bullets_array %}
                <li>
                  <div class="dv-story-card__checkmark-wrapper">
                    <svg class="dv-story-card__checkmark" width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <span class="dv-story-card__bullet-text">{{ bullet | escape }}</span>
                </li>
              {% endfor %}
            {% endif %}
          </ul>
        </div>
      {% endif %}

      {%- comment -%} Disclaimer {%- endcomment -%}
      {% if section.settings.show_disclaimer %}
        <p class="dv-story-card__disclaimer">
          {{ section.settings.disclaimer_text | default: 'AYURVEDISCH INSPIRIERTE GENUSS-TRADITION. KEIN HEILVERSPRECHEN.' | escape }}
        </p>
      {% endif %}

    </div>
  </div>
</section>
{% endif %}

{% schema %}
{
  "name": "DV Story Card",
  "tag": "section",
  "class": "dynamic-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Story Title",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_story_title (DV Story Title) or enter text manually. If empty and animal_name is set, auto-generates as 'Warum der {Animal}?'"
    },
    {
      "type": "text",
      "id": "animal_name",
      "label": "Animal Name",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_animal_name (DV Animal Name) or enter text manually. Used for auto-generating title."
    },
    {
      "type": "richtext",
      "id": "content",
      "label": "Story Content",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_story_content (DV Story Content - Rich text) or enter content manually"
    },
    {
      "type": "textarea",
      "id": "traditional_benefits",
      "label": "Traditional Benefits (Fallback)",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_traditional_benefits (DV Traditional Benefits - Multi-line text) or enter text manually. Used if checklist blocks are empty (one bullet per line)."
    },
    {
      "type": "checkbox",
      "id": "show_when_empty",
      "label": "Show section even if all markers are empty",
      "default": false
    },
    {
      "type": "header",
      "content": "Icon"
    },
    {
      "type": "checkbox",
      "id": "show_fox_icon",
      "label": "Show animal icon",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "fox_icon",
      "label": "Animal icon image",
      "info": "Fallback animal icon image (used if product.metafields.custom.dv_animal_image is not set). For blend-specific images, set the 'DV Animal Image' metafield on each product instead."
    },
    {
      "type": "range",
      "id": "icon_size",
      "label": "Icon size",
      "min": 80,
      "max": 200,
      "step": 10,
      "unit": "px",
      "default": 140,
      "info": "Size of the animal icon in pixels"
    },
    {
      "type": "header",
      "content": "Right Column - Checklist Section"
    },
    {
      "type": "text",
      "id": "checklist_heading",
      "label": "Checklist Title",
      "default": "Traditionell geschätzt für …",
      "info": "The heading text displayed above the checklist items (e.g., 'Traditionell geschätzt für …')"
    },
    {
      "type": "paragraph",
      "content": "Checklist items are added via blocks below. Click 'Add block' and select 'Checklist Item' to add individual bullet points."
    },
    {
      "type": "header",
      "content": "Right Column - Disclaimer"
    },
    {
      "type": "checkbox",
      "id": "show_disclaimer",
      "label": "Show disclaimer",
      "default": true
    },
    {
      "type": "text",
      "id": "disclaimer_text",
      "label": "Disclaimer Text",
      "default": "AYURVEDISCH INSPIRIERTE GENUSS-TRADITION. KEIN HEILVERSPRECHEN.",
      "info": "Text displayed at the bottom of the right column (shown in uppercase, smaller font)"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#f3e9dc"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 120,
      "step": 8,
      "unit": "px",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 120,
      "step": 8,
      "unit": "px",
      "default": 48
    }
  ],
  "blocks": [
    {
      "type": "checklist_item",
      "name": "Checklist Item",
      "limit": 5,
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Bullet Point Text",
          "default": "Erdende Wärme an kalten Tagen",
          "info": "Text for this individual checklist item. Each block becomes one bullet point with a checkmark."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "DV Story Card",
      "blocks": [
        {
          "type": "checklist_item",
          "settings": {
            "text": "Erdende Wärme an kalten Tagen"
          }
        },
        {
          "type": "checklist_item",
          "settings": {
            "text": "Einen klaren, fokussierten Start"
          }
        },
        {
          "type": "checklist_item",
          "settings": {
            "text": "Innere Balance und Wohlbefinden"
          }
        }
      ]
    }
  ]
}
{% endschema %}

