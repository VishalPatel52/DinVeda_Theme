{% comment %}
  DinVeda Recipe Preparation - "Anwendung & Zubereitung"
  Recipe cards in grid layout with multiple recipe blocks
{% endcomment %}

{%- liquid
  assign is_design_mode = request.design_mode
  
  # Priority 1: Check for recipe cards from metaobject list (product metafield)
  assign recipe_cards_meta = null
  assign has_recipe_cards_meta = false
  if product.metafields.custom.dv_recipe_cards
    assign recipe_cards_meta = product.metafields.custom.dv_recipe_cards.value
    if recipe_cards_meta and recipe_cards_meta.size > 0
      assign has_recipe_cards_meta = true
    endif
  endif
  
  # Priority 2: Check for recipe blocks (fallback)
  assign has_recipe_blocks = false
  if section.blocks.size > 0
    for block in section.blocks
      if block.type == 'recipe_card'
        assign has_recipe_blocks = true
        break
      endif
    endfor
  endif

  # Auto-generate intro text from theme editor settings (can be connected to metafields)
  assign intro_text = section.settings.intro_text
  if intro_text == blank and product != blank
    assign tier_name = section.settings.animal_name
    assign product_name = product.title
    if tier_name != blank and product_name != blank
      assign intro_text = 'So verwendet der ' | append: tier_name | append: ' ' | append: product_name | append: ' in seinem Alltag:'
    endif
  endif
  
  # Ritual im Detail micro-block (from theme editor settings, can be connected to metafields)
  assign taste_notes = section.settings.taste_character
  assign pairing_ideas = section.settings.pairing_ideas
  assign serving_suggestion = section.settings.serving_suggestion
  assign frequency = section.settings.frequency
  
  assign has_ritual_detail = false
  if section.settings.show_ritual_detail_block
    if taste_notes != blank or pairing_ideas != blank or serving_suggestion != blank or frequency != blank
      assign has_ritual_detail = true
    endif
  endif
  
  if has_recipe_cards_meta or has_recipe_blocks or section.settings.show_when_empty or is_design_mode
    assign should_show = true
  else
    assign should_show = false
  endif
-%}

{% if should_show %}
  <section
    id="dinveda-recipe-preparation-{{ section.id }}"
    class="dinveda-recipe-preparation"
    data-section-id="{{ section.id }}"
    data-section-type="dinveda-recipe-preparation"
    style="padding-top: {{ section.settings.padding_top }}px; padding-bottom: {{ section.settings.padding_bottom }}px;"
    {{ section.shopify_attributes }}
  >
    <div class="dinveda-recipe-preparation__container">
      <details class="details" id="recipe-preparation-{{ section.id }}">
        <summary class="details__summary">
          <h3 class="details__title">{{ section.settings.accordion_title | default: "Dein tägliches Ritual" | escape }}</h3>
          <div class="details__icon">
            {% render 'snip-icons',
              wrapper: '',
              type: 'theme',
              icon: 'down-carrot',
              size: '8px',
              classes: 'details__svg vib-center',
              fill: 'var(--accordion-color)',
              hover: 'var(--accordion-color)' %}
          </div>
        </summary>
        <div class="details__content">
          {% if intro_text != blank %}
            <p class="dinveda-recipe-preparation__intro">
              {{ intro_text | escape }}
            </p>
          {% endif %}

          {%- comment -%} Ritual im Detail micro-block {%- endcomment -%}
          {% if has_ritual_detail %}
            <div class="dinveda-recipe-preparation__ritual-detail">
              <div class="dinveda-recipe-preparation__ritual-detail-grid">
                {% if taste_notes != blank %}
                  <div class="dinveda-recipe-preparation__ritual-detail-item">
                    <div class="dinveda-recipe-preparation__ritual-detail-label">Geschmack</div>
                    <div class="dinveda-recipe-preparation__ritual-detail-value">{{ taste_notes | escape }}</div>
                  </div>
                {% endif %}
                {% if pairing_ideas != blank %}
                  <div class="dinveda-recipe-preparation__ritual-detail-item">
                    <div class="dinveda-recipe-preparation__ritual-detail-label">Passt zu</div>
                    <div class="dinveda-recipe-preparation__ritual-detail-value">{{ pairing_ideas | newline_to_br }}</div>
                  </div>
                {% endif %}
                {% if serving_suggestion != blank %}
                  <div class="dinveda-recipe-preparation__ritual-detail-item">
                    <div class="dinveda-recipe-preparation__ritual-detail-label">Portion</div>
                    <div class="dinveda-recipe-preparation__ritual-detail-value">{{ serving_suggestion | newline_to_br }}</div>
                  </div>
                {% endif %}
                {% if frequency != blank %}
                  <div class="dinveda-recipe-preparation__ritual-detail-item">
                    <div class="dinveda-recipe-preparation__ritual-detail-label">Häufigkeit</div>
                    <div class="dinveda-recipe-preparation__ritual-detail-value">{{ frequency | escape }}</div>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endif %}

          {%- comment -%} Recipe Cards: Priority = MetaObjects, Fallback = Blocks {%- endcomment -%}
          {% if has_recipe_cards_meta or has_recipe_blocks %}
            <div class="dinveda-recipe-preparation__grid">
              {%- comment -%} Priority: MetaObjects from theme editor {%- endcomment -%}
              {% if has_recipe_cards_meta %}
                {% for recipe_card in recipe_cards_meta %}
                  <div class="dinveda-recipe-preparation__card">
                    {% if recipe_card.title != blank %}
                      <h3 class="dinveda-recipe-preparation__card-title">{{ recipe_card.title | escape }}</h3>
                    {% endif %}
                    {% if recipe_card.body != blank %}
                      <div class="dinveda-recipe-preparation__card-body">
                        {{ recipe_card.body }}
                      </div>
                    {% endif %}
                  </div>
                {% endfor %}
              {%- comment -%} Fallback: Blocks {%- endcomment -%}
              {% elsif has_recipe_blocks %}
                {% assign recipe_count = 0 %}
                {% for block in section.blocks %}
                  {% if block.type == 'recipe_card' %}
                    {% if recipe_count < 3 %}
                      <div class="dinveda-recipe-preparation__card" {{ block.shopify_attributes }}>
                        {% if block.settings.title != blank %}
                          <h3 class="dinveda-recipe-preparation__card-title">{{ block.settings.title | escape }}</h3>
                        {% endif %}
                        {% if block.settings.body != blank %}
                          <div class="dinveda-recipe-preparation__card-body">
                            {{ block.settings.body }}
                          </div>
                        {% endif %}
                      </div>
                      {% assign recipe_count = recipe_count | plus: 1 %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            </div>
          {% else %}
            <div class="dinveda-recipe-preparation__empty-state">
              <p class="dinveda-recipe-preparation__empty-message">
                Connect product.metafields.custom.dv_recipe_cards (DV Recipe Cards - list of DV Recipe Card metaobjects) via product metafields, or click "Add block" to add recipe cards.
              </p>
            </div>
          {% endif %}
        </div>
      </details>
    </div>
  </section>
{% endif %}

{% schema %}
{
  "name": "Anwendung & Zubereitung",
  "tag": "section",
  "class": "dynamic-section",
  "settings": [
    {
      "type": "text",
      "id": "accordion_title",
      "label": "Accordion Title",
      "default": "Dein tägliches Ritual",
      "info": "Title shown in accordion header"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading (deprecated)",
      "info": "Deprecated - use accordion_title instead"
    },
    {
      "type": "select",
      "id": "icon",
      "label": "Icon",
      "options": [
        { "value": "restaurant", "label": "Restaurant" },
        { "value": "dining", "label": "Dining" },
        { "value": "local_dining", "label": "Local Dining" },
        { "value": "self_improvement", "label": "Self Improvement" }
      ],
      "default": "restaurant"
    },
    {
      "type": "text",
      "id": "intro_text",
      "label": "Intro Text",
      "info": "Optional intro text. Leave blank to auto-generate from Animal Name setting below (e.g., 'So verwendet der {Animal} {Product Name} in seinem Alltag:')"
    },
    {
      "type": "text",
      "id": "animal_name",
      "label": "Animal Name",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_animal_name (DV Animal Name) or enter text manually. Used for intro text auto-generation."
    },
    {
      "type": "header",
      "content": "Ritual Details - Connect to Product Metafields"
    },
    {
      "type": "textarea",
      "id": "taste_character",
      "label": "Taste Character (Geschmack)",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_taste_character (DV Taste Character - Multi-line text) or enter text manually"
    },
    {
      "type": "textarea",
      "id": "pairing_ideas",
      "label": "Pairing Ideas (Passt zu)",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_pairing_ideas (DV Pairing Ideas - Multi-line text) or enter text manually"
    },
    {
      "type": "textarea",
      "id": "serving_suggestion",
      "label": "Serving Suggestion (Portion)",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_serving_suggestion (DV Serving Suggestion - Multi-line text) or enter text manually"
    },
    {
      "type": "text",
      "id": "frequency",
      "label": "Frequency (Häufigkeit)",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_frequency (DV Frequency - Single line text) or enter text manually"
    },
    {
      "type": "header",
      "content": "Recipe Cards"
    },
    {
      "type": "paragraph",
      "content": "Connect product.metafields.custom.dv_recipe_cards (DV Recipe Cards - list of DV Recipe Card metaobjects) via product metafields, or add blocks below as fallback"
    },
    {
      "type": "checkbox",
      "id": "show_when_empty",
      "label": "Show section even if no blocks are added",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_ritual_detail_block",
      "label": "Show Ritual im Detail block",
      "info": "Display taste, pairing, serving, and frequency details from settings above (can be connected to metafields via dynamic source).",
      "default": true
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "cards_per_row",
      "label": "Cards per row (desktop)",
      "min": 1,
      "max": 3,
      "step": 1,
      "default": 2
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 120,
      "step": 8,
      "unit": "px",
      "default": 24
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 120,
      "step": 8,
      "unit": "px",
      "default": 24
    }
  ],
  "blocks": [
    {
      "type": "recipe_card",
      "name": "Recipe Card (Fallback)",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Recipe Title",
          "info": "Recipe title (e.g., 'Sanfter Tee- oder Drink-Moment'). Used as fallback if Recipe Cards setting above is empty."
        },
        {
          "type": "richtext",
          "id": "body",
          "label": "Recipe Instructions",
          "info": "Recipe instructions (e.g., '1 TL (~3 g) in 200 ml warme Pflanzenmilch...'). Used as fallback if Recipe Cards setting above is empty."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Anwendung & Zubereitung",
      "blocks": [
        {
          "type": "recipe_card",
          "settings": {
            "title": "Sanfter Tee- oder Drink-Moment",
            "body": "<p>1 TL (~3 g) in 200 ml warme Pflanzenmilch oder warmes Wasser einrühren. Optional mit etwas Honig oder Agavendicksaft süßen.</p>"
          }
        },
        {
          "type": "recipe_card",
          "settings": {
            "title": "Als Smoothie oder Shake",
            "body": "<p>1 TL (~3 g) mit 200 ml pflanzlicher Milch, einer Banane und optional etwas Datteln oder Ahornsirup in den Mixer geben und cremig mixen.</p>"
          }
        }
      ]
    }
  ]
}
{% endschema %}

