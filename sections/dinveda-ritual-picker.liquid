{% comment %}
  DinVeda Ritual Picker - Premium ritual navigation section
  "Dein Tag in Balance" with 4 ritual cards
{% endcomment %}

{%- liquid
  assign background_mode = section.settings.background_mode | default: 'design_bg'
  assign layout = section.settings.layout | default: 'grid_4'
  assign emphasize_center = section.settings.emphasize_center_card
  assign section_spacing = section.settings.section_spacing | default: 'medium'
-%}

<link rel="preload" href="{{ 'section-dinveda-ritual-picker.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="{{ 'section-dinveda-ritual-picker.css' | asset_url }}"></noscript>

<section
  id="dinveda-ritual-picker-{{ section.id }}"
  class="dinveda-ritual-picker dinveda-ritual-picker--layout-{{ layout }}"
  data-section-id="{{ section.id }}"
  data-section-type="dinveda-ritual-picker"
>
  <div class="dinveda-ritual-picker__container">
    
    {%- comment -%} Section Header {%- endcomment -%}
    {% if section.settings.title != blank or section.settings.subtitle != blank or section.settings.intro != blank %}
      <div class="dinveda-ritual-picker__header">
        {% if section.settings.title != blank %}
          <h2 class="dinveda-ritual-picker__title">{{ section.settings.title | escape }}</h2>
        {% endif %}
        {% if section.settings.subtitle != blank %}
          <p class="dinveda-ritual-picker__subtitle">{{ section.settings.subtitle | escape }}</p>
        {% endif %}
        {% if section.settings.intro != blank %}
          <div class="dinveda-ritual-picker__intro">
            {{ section.settings.intro }}
          </div>
        {% endif %}
      </div>
    {% endif %}

    {%- comment -%} Ritual Cards Grid {%- endcomment -%}
    {% if section.blocks.size > 0 %}
      <div class="dinveda-ritual-picker__grid dinveda-ritual-picker__grid--{{ layout }}">
        {% for block in section.blocks %}
          {% if block.type == 'ritual_card' %}
            {%- liquid
              assign selected_product = block.settings.product
              
              # Resolve link: product.url > block.settings.link > blank
              if selected_product != blank
                assign card_link = selected_product.url
              elsif block.settings.link != blank
                assign card_link = block.settings.link
              else
                assign card_link = blank
              endif
              
              # Fallbacks: use product data if custom fields are blank
              assign phase_label = block.settings.phase_label
              
              if block.settings.blend_name != blank
                assign blend_name = block.settings.blend_name
              elsif selected_product != blank
                assign blend_name = selected_product.title
              else
                assign blend_name = blank
              endif
              
              assign animal_name = block.settings.animal_name
              assign quote_line = block.settings.quote_line
              assign descriptor = block.settings.descriptor
              
              # Image fallback: custom image > product featured image > placeholder
              if block.settings.image != blank
                assign card_image = block.settings.image
              elsif selected_product != blank and selected_product.featured_image != blank
                assign card_image = selected_product.featured_image
              else
                assign card_image = blank
              endif
              
              # Image alt fallback: custom alt > blend_name > product title > phase_label
              if block.settings.image_alt != blank
                assign image_alt = block.settings.image_alt
              elsif blend_name != blank
                assign image_alt = blend_name
              elsif selected_product != blank
                assign image_alt = selected_product.title
              else
                assign image_alt = phase_label
              endif
              
              assign button_label = block.settings.button_label | default: 'Zu diesem Ritual'
              assign badge_text = block.settings.badge
              assign accent_variant = block.settings.accent_variant | default: 'none'
              assign is_center = false
              if emphasize_center and forloop.index == 2
                assign is_center = true
              endif
            -%}
            
            <article 
              class="dinveda-ritual-picker__card dinveda-ritual-picker__card--accent-{{ accent_variant }}{% if is_center %} dinveda-ritual-picker__card--emphasized{% endif %}{% if card_link != blank %} dinveda-ritual-picker__card--has-link{% endif %}" 
              {{ block.shopify_attributes }}
            >
              <div class="dinveda-ritual-picker__card-inner">
                
                {%- comment -%} Stretched link for entire card clickability (first child) {%- endcomment -%}
                {% if card_link != blank %}
                  {%- liquid
                    assign link_aria_label = blend_name | default: phase_label | default: 'Ritual card'
                  -%}
                  <a href="{{ card_link }}" class="dinveda-ritual-picker__stretched-link" aria-label="{{ link_aria_label | escape }}"></a>
                {% endif %}
                
                {%- comment -%} Badge {%- endcomment -%}
                {% if badge_text != blank %}
                  <div class="dinveda-ritual-picker__badge">
                    {{ badge_text | escape }}
                  </div>
                {% endif %}

                {%- comment -%} Image {%- endcomment -%}
                {% if card_image != blank %}
                  {%- liquid
                    assign image_alt_escaped = image_alt | escape
                  -%}
                  <div class="dinveda-ritual-picker__image-wrapper">
                    {{ card_image | image_url: width: 600 | image_tag: alt: image_alt_escaped, loading: 'lazy', class: 'dinveda-ritual-picker__image' }}
                  </div>
                {% else %}
                  <div class="dinveda-ritual-picker__image-wrapper dinveda-ritual-picker__image-wrapper--placeholder">
                    {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder-svg' }}
                  </div>
                {% endif %}

                {%- comment -%} Content {%- endcomment -%}
                <div class="dinveda-ritual-picker__content">
                  
                  {% if phase_label != blank %}
                    <p class="dinveda-ritual-picker__phase-label">{{ phase_label | escape }}</p>
                  {% endif %}

                  {% if blend_name != blank %}
                    <h3 class="dinveda-ritual-picker__blend-name">{{ blend_name | escape }}</h3>
                  {% endif %}

                  {% if quote_line != blank %}
                    <div class="dinveda-ritual-picker__quote-block">
                      <p class="dinveda-ritual-picker__quote-line">{{ quote_line | escape }}</p>
                      {% if animal_name != blank %}
                        <p class="dinveda-ritual-picker__animal-name">— {{ animal_name | escape }}</p>
                      {% endif %}
                    </div>
                  {% endif %}

                  {% if descriptor != blank %}
                    <p class="dinveda-ritual-picker__descriptor">{{ descriptor | escape }}</p>
                  {% endif %}

                  {%- comment -%} CTA Button as real link (takes priority over stretched link) {%- endcomment -%}
                  {% if button_label != blank %}
                    <div class="dinveda-ritual-picker__button-wrapper">
                      {% if card_link != blank %}
                        <a href="{{ card_link }}" class="dinveda-ritual-picker__button button btn-outline">
                          {{ button_label | escape }}
                        </a>
                      {% else %}
                        <span class="dinveda-ritual-picker__button button btn-outline">
                          {{ button_label | escape }}
                        </span>
                      {% endif %}
                    </div>
                  {% endif %}

                </div>

              </div>
            </article>

          {% endif %}
        {% endfor %}
      </div>
    {% endif %}

    {%- comment -%} Section CTA {%- endcomment -%}
    {% if section.settings.cta_label != blank and section.settings.cta_link != blank %}
      <div class="dinveda-ritual-picker__cta">
        <a href="{{ section.settings.cta_link }}" class="button btn-outline">
          {{ section.settings.cta_label | escape }}
        </a>
      </div>
    {% endif %}

  </div>
</section>

{% style %}
  #dinveda-ritual-picker-{{ section.id }} {
    {% case background_mode %}
      {% when 'design_bg' %}
        background-color: var(--design-bg-color);
      {% when 'design_secondary_bg' %}
        background-color: var(--design-secondary-bg);
      {% when 'transparent' %}
        background-color: transparent;
    {% endcase %}
    
    {% case section_spacing %}
      {% when 'small' %}
        padding: var(--design-section-spacing-small) 0;
      {% when 'medium' %}
        padding: var(--design-section-spacing-medium) 0;
      {% when 'large' %}
        padding: var(--design-section-spacing-large) 0;
    {% endcase %}
  }
{% endstyle %}

{% schema %}
{
  "name": "DinVeda — Ritual Picker",
  "tag": "section",
  "class": "dynamic-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Dein Tag in Balance"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Vier Momente am Tag — ein kleines Ritual für dich"
    },
    {
      "type": "textarea",
      "id": "intro",
      "label": "Intro text (optional)",
      "info": "Optional introductory text below subtitle"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "layout",
      "label": "Card layout",
      "options": [
        {
          "value": "grid_4",
          "label": "4 cards grid (desktop) / 1 card (mobile)"
        },
        {
          "value": "grid_2x2",
          "label": "2x2 grid (desktop) / 1 card (mobile)"
        },
        {
          "value": "slider_mobile",
          "label": "4 cards grid (desktop) / slider (mobile)"
        }
      ],
      "default": "grid_4"
    },
    {
      "type": "checkbox",
      "id": "emphasize_center_card",
      "label": "Emphasize center card",
      "default": true,
      "info": "Visually emphasize the 2nd card on desktop"
    },
    {
      "type": "select",
      "id": "section_spacing",
      "label": "Section spacing",
      "options": [
        {
          "value": "small",
          "label": "Small"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "large",
          "label": "Large"
        }
      ],
      "default": "medium"
    },
    {
      "type": "select",
      "id": "background_mode",
      "label": "Background color",
      "options": [
        {
          "value": "design_bg",
          "label": "Design System Background"
        },
        {
          "value": "design_secondary_bg",
          "label": "Design System Secondary Background"
        },
        {
          "value": "transparent",
          "label": "Transparent"
        }
      ],
      "default": "design_bg"
    },
    {
      "type": "header",
      "content": "Call to Action"
    },
    {
      "type": "text",
      "id": "cta_label",
      "label": "CTA button label (optional)"
    },
    {
      "type": "url",
      "id": "cta_link",
      "label": "CTA button link (optional)"
    }
  ],
  "blocks": [
    {
      "type": "ritual_card",
      "name": "Ritual card",
      "limit": 4,
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product (recommended)",
          "info": "Select a product to automatically link this card. Product title and image will be used as fallbacks if fields below are empty."
        },
        {
          "type": "text",
          "id": "phase_label",
          "label": "Phase label",
          "default": "MORGEN · ACTIVATE",
          "info": "e.g., 'MORGEN · ACTIVATE', 'TAG · ZENTRIEREN'"
        },
        {
          "type": "text",
          "id": "blend_name",
          "label": "Blend name",
          "default": "Golden Boost"
        },
        {
          "type": "text",
          "id": "animal_name",
          "label": "Animal name",
          "default": "Fuchs",
          "info": "e.g., 'Fuchs', 'Bär', 'Eule'"
        },
        {
          "type": "text",
          "id": "quote_line",
          "label": "Quote line",
          "default": "Ich starte kraftvoll und klar in den Tag."
        },
        {
          "type": "text",
          "id": "descriptor",
          "label": "Descriptor",
          "default": "Für Energie, Fokus & innere Wärme"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Animal illustration or pouch photo"
        },
        {
          "type": "text",
          "id": "image_alt",
          "label": "Image alt text (optional)",
          "info": "If not set, uses blend name"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link (fallback)",
          "info": "Optional URL fallback if product is not selected. Product URL takes priority."
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Button label",
          "default": "Zu diesem Ritual"
        },
        {
          "type": "text",
          "id": "badge",
          "label": "Badge (optional)",
          "info": "Optional badge text, e.g., 'Bestseller'"
        },
        {
          "type": "select",
          "id": "accent_variant",
          "label": "Accent variant",
          "options": [
            {
              "value": "none",
              "label": "None"
            },
            {
              "value": "warm",
              "label": "Warm"
            },
            {
              "value": "calm",
              "label": "Calm"
            },
            {
              "value": "floral",
              "label": "Floral"
            },
            {
              "value": "night",
              "label": "Night"
            }
          ],
          "default": "none",
          "info": "Subtle accent styling using design system accent color"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "DinVeda — Ritual Picker",
      "blocks": [
        {
          "type": "ritual_card",
          "settings": {
            "phase_label": "MORGEN · ACTIVATE",
            "blend_name": "Golden Boost",
            "animal_name": "Fuchs",
            "quote_line": "Ich starte clever in den Tag.",
            "descriptor": "Für Energie, Fokus & innere Wärme",
            "button_label": "Zu diesem Ritual"
          }
        },
        {
          "type": "ritual_card",
          "settings": {
            "phase_label": "TAG · ZENTRIEREN",
            "blend_name": "Flow & Glow",
            "animal_name": "Panda",
            "quote_line": "Ich genieße Balance und Ruhe.",
            "descriptor": "Für Leichtigkeit, Balance & innere Strahlkraft",
            "button_label": "Zu diesem Ritual"
          }
        },
        {
          "type": "ritual_card",
          "settings": {
            "phase_label": "NACHMITTAG · HARMONISIEREN",
            "blend_name": "Ova Harmony",
            "animal_name": "Schmetterling",
            "quote_line": "Ich blühe in Leichtigkeit & Harmonie.",
            "descriptor": "Für Ausgleich, Harmonie & sanfte Energie",
            "button_label": "Zu diesem Ritual"
          }
        },
        {
          "type": "ritual_card",
          "settings": {
            "phase_label": "ABEND · LOSLASSEN",
            "blend_name": "Moon Rest",
            "animal_name": "Koala",
            "quote_line": "Ich finde Ruhe am Abend und lasse los.",
            "descriptor": "Für Entspannung, Ruhe & erholsamen Schlaf",
            "button_label": "Zu diesem Ritual"
          }
        }
      ]
    }
  ]
}
{% endschema %}
