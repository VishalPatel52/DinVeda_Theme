{% comment %} DinVeda Premium Cart Items Section {% endcomment %}
{% comment %} Cart Page Assets {% endcomment %}
<link
  rel="preload"
  href="{{ 'section-main-cart.css' | asset_url }}"
  as="style"
  onload="this.onload=null;this.rel='stylesheet'"
>
<noscript><link rel="stylesheet" href="{{ 'section-main-cart.css' | asset_url }}"></noscript>

{%- liquid
  assign show_ritual_timing = section.settings.show_ritual_timing
  if show_ritual_timing == blank
    assign show_ritual_timing = true
  endif

  assign ritual_timing_fallback_tag = section.settings.ritual_timing_fallback_tag
  if ritual_timing_fallback_tag == blank
    assign ritual_timing_fallback_tag = true
  endif

  assign show_variant_title = section.settings.show_variant_title
  if show_variant_title == blank
    assign show_variant_title = true
  endif

  assign checkout_button_label = section.settings.checkout_button_label
  if checkout_button_label == blank
    assign checkout_button_label = 'ZUR KASSE'
  endif

  assign show_security_badges = section.settings.show_security_badges
  if show_security_badges == blank
    assign show_security_badges = true
  endif

  assign show_shipping = section.settings.show_shipping
  assign show_tax_note = section.settings.show_tax_note
-%}

{%- liquid
  assign fox_image_url = ''
  assign fox_image_setting = section.settings.empty_cart_fox_image
  if fox_image_setting != blank and fox_image_setting != null
    assign fox_image_url = fox_image_setting | image_url: width: 240
  endif
-%}
{% if fox_image_url != blank and fox_image_url != '' %}
<script type="application/json" id="cart-fox-image-config">
  {
    "fox_image_url": {{ fox_image_url | json }}
  }
</script>
<script>
  // Store animal image URL globally for drawer access
  if (typeof window !== 'undefined') {
    window.cartFoxImageUrl = {{ fox_image_url | json }};
  }
</script>
{% endif %}
<section
  class="dinveda-cart-items dinveda-cart-items-{{ section.id }} cart-page ajax-cart__page-wrapper pt8 mb8"
  data-section-id="{{ section.id }}"
  data-section-type="cart-template"
  data-section-loaded="false"
  {% if fox_image_url != blank and fox_image_url != '' %}data-empty-cart-fox-image="{{ fox_image_url }}"{% endif %}
>
  <div class="loading-wrapper js-mini-cart-loader no-js-hidden">
    <div class="loading-ripple"><div></div><div></div></div>
  </div>

  <div class="dinveda-cart-items__wrapper">
    <div class="grid__wrapper">
      <div class="dinveda-cart-items__main span-12 lg-span-8 auto">
        <div class="dinveda-cart-items__header">
          <h2 class="dinveda-cart-items__title">{{ 'cart.general.title' | t }} <span class="dinveda-cart-items__count">(<span class="js-cart-count">{{ cart.item_count }}</span> {{ 'cart.general.items' | t }})</span></h2>
          <span class="dinveda-cart-items__label">{{ section.settings.cart_label | default: 'YOUR RITUALS' }}</span>
        </div>

        <div class="ajax-cart__form-wrapper--nojs js-ajax-cart-content-nojs">
          {% render "cart-no-js", cart: cart, section: section %}
        </div>

        <div class="ajax-cart__form-wrapper cart-wrapper js-ajax-cart-content">
          {% if cart.item_count > 0 %}
            <form class="dinveda-cart-items__form js-cart-form"
                  action="{{ routes.cart_url }}"
                  method="post">
              <div class="dinveda-cart-items__list">
                {% for item in cart.items %}
                  <div class="dinveda-cart-item" data-item-id="{{ item.id }}-{{ forloop.index }}" data-item-key="{{ item.key }}">
                    <div class="dinveda-cart-item__card">
                      {%- comment -%} Product Image {%- endcomment -%}
                      <div class="dinveda-cart-item__image">
                        <a href="{{ item.url }}" title="{{ item.product.title | escape }}">
                          {% if item.image != blank %}
                            {% liquid
                              if forloop.index > 3
                                assign loading = 'lazy'
                              else
                                assign loading = 'eager'
                              endif
                            %}
                            {{ item.image | image_url: width: 200 | image_tag: loading: loading, alt: item.product.title, class: 'dinveda-cart-item__image-img' }}
                          {% else %}
                            <span class="dinveda-cart-item__placeholder">{{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}</span>
                          {% endif %}
                        </a>
                      </div>

                      {%- comment -%} Product Details {%- endcomment -%}
                      <div class="dinveda-cart-item__details">
                        {%- comment -%} Ritual Timing Label {%- endcomment -%}
                        {% if show_ritual_timing %}
                          {%- liquid
                            assign ritual_timing_label = item.product.metafields.dinveda.ritual_timing.value
                            if ritual_timing_label == blank and ritual_timing_fallback_tag
                              if item.product.tags contains 'Morgen'
                                assign ritual_timing_label = 'MORGEN | AKTIVIEREN'
                              elsif item.product.tags contains 'Tag'
                                assign ritual_timing_label = 'TAG | ZENTRIEREN'
                              elsif item.product.tags contains 'Abend'
                                assign ritual_timing_label = 'ABEND | LOSLASSEN'
                              elsif item.product.tags contains 'Balance'
                                assign ritual_timing_label = 'BALANCE | AUSGLEICHEN'
                              endif
                            endif
                          -%}
                          {% if ritual_timing_label != blank %}
                            <div class="dinveda-cart-item__ritual-timing">{{ ritual_timing_label | escape }}</div>
                          {% endif %}
                        {% endif %}

                        {%- comment -%} Product Title {%- endcomment -%}
                        <h3 class="dinveda-cart-item__title">
                          <a href="{{ item.url }}">{{ item.product.title }}</a>
                        </h3>

                        {%- comment -%} Variant Title {%- endcomment -%}
                        {% if show_variant_title and item.variant.title != blank and item.variant.title != 'Default Title' %}
                          <p class="dinveda-cart-item__variant">{{ item.variant.title }}</p>
                        {% endif %}

                        {%- comment -%} Remove Button {%- endcomment -%}
                        <button class="dinveda-cart-item__remove js-cart-remove" 
                                data-item-id="{{ item.id }}-{{ forloop.index }}" 
                                data-item-key="{{ item.key }}" 
                                data-line-item="{{ forloop.index }}"
                                type="button">
                          {{ 'cart.general.remove' | t }}
                        </button>
                      </div>

                      {%- comment -%} Quantity and Price {%- endcomment -%}
                      <div class="dinveda-cart-item__actions">
                        {%- comment -%} Quantity Selector {%- endcomment -%}
                        <div class="dinveda-cart-item__quantity js-item-quantity">
                          <button
                            data-ajax-qty-decrease="{{ item.id }}-{{ forloop.index }}"
                            data-item-key="{{ item.key }}"
                            class="dinveda-cart-item__qty-btn dinveda-cart-item__qty-btn--decrease"
                            type="button"
                            aria-label="{{ 'cart.general.decrease' | t: product: item.title | escape }}">
                            <span class="visually-hidden">{{ 'cart.general.decrease' | t: product: item.title | escape }}</span>
                            <span class="dinveda-cart-item__qty-icon">−</span>
                          </button>
                          <input id="updates_{{ item.id }}-{{ forloop.index }}" 
                                 class="dinveda-cart-item__qty-input"
                                 data-item-qty
                                 data-item-id="{{ item.id }}-{{ forloop.index }}"
                                 data-item-key="{{ item.key }}"
                                 data-item-line="{{ forloop.index }}"
                                 aria-label="{{ 'cart.general.input_label' | t: product: item.title | escape }}"
                                 type="number"
                                 name="updates[]"
                                 value="{{ item.quantity }}"
                                 min="0"
                                 data-limit="{% if item.variant.inventory_management == 'shopify' %}{% unless item.variant.inventory_policy == 'continue' %}{{ item.variant.inventory_quantity }}{% endunless %}{% endif %}" />
                          <button
                            data-ajax-qty-increase="{{ item.id }}-{{ forloop.index }}"
                            data-item-key="{{ item.key }}"
                            class="dinveda-cart-item__qty-btn dinveda-cart-item__qty-btn--increase"
                            type="button"
                            aria-label="{{ 'cart.general.increase' | t: product: item.title | escape }}">
                            <span class="visually-hidden">{{ 'cart.general.increase' | t: product: item.title | escape }}</span>
                            <span class="dinveda-cart-item__qty-icon">+</span>
                          </button>
                        </div>

                        {%- comment -%} Price {%- endcomment -%}
                        <div class="dinveda-cart-item__price">
                          {%- assign has_discount = false -%}
                          {%- if item.original_price != item.final_price -%}
                            {%- assign has_discount = true -%}
                          {%- endif -%}
                          <span data-cart-item-final-price>{{ item.final_price | money }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </form>
          {% else %}
            {%- liquid
              assign empty_message = section.settings.empty_cart_message
              if empty_message == blank or empty_message == null
                assign empty_message = 'Dein Warenkorb ist leer'
              endif
              
              assign button_text = section.settings.empty_cart_button_text
              if button_text == blank or button_text == null
                assign button_text = 'Jetzt Einkaufen'
              endif
              
              assign button_link = section.settings.empty_cart_button_link
              if button_link == blank or button_link == null
                assign button_link = routes.root_url
              endif
              
              assign fox_image = section.settings.empty_cart_fox_image
            -%}
            <div class="dinveda-cart-items__empty js-cart-empty">
              <div class="dinveda-cart-items__empty-content">
                <div class="dinveda-cart-items__empty-fox">
                  {% if fox_image != blank and fox_image != null %}
                    {{ fox_image | image_url: width: 240 | image_tag: alt: 'Animal', loading: 'lazy', class: 'dinveda-cart-items__empty-fox-img' }}
                  {% else %}
                    {% comment %} Default panda SVG - cute baby panda {% endcomment %}
                    <svg class="dinveda-cart-items__empty-fox-img" width="240" height="240" viewBox="0 0 240 240" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <!-- Head (white) -->
                      <ellipse cx="120" cy="100" rx="55" ry="60" fill="#FFFFFF"/>
                      <!-- Left ear (black) -->
                      <ellipse cx="85" cy="65" rx="18" ry="22" fill="#000000"/>
                      <!-- Right ear (black) -->
                      <ellipse cx="155" cy="65" rx="18" ry="22" fill="#000000"/>
                      <!-- Left eye patch (black) -->
                      <ellipse cx="100" cy="90" rx="16" ry="18" fill="#000000"/>
                      <!-- Right eye patch (black) -->
                      <ellipse cx="140" cy="90" rx="16" ry="18" fill="#000000"/>
                      <!-- Left eye (white highlight) -->
                      <circle cx="105" cy="92" r="6" fill="#FFFFFF"/>
                      <!-- Right eye (white highlight) -->
                      <circle cx="135" cy="92" r="6" fill="#FFFFFF"/>
                      <!-- Left eye pupil -->
                      <circle cx="107" cy="93" r="3" fill="#8B4513"/>
                      <!-- Right eye pupil -->
                      <circle cx="137" cy="93" r="3" fill="#8B4513"/>
                      <!-- Nose (black) -->
                      <ellipse cx="120" cy="108" rx="6" ry="5" fill="#000000"/>
                      <!-- Mouth (smile) -->
                      <path d="M115 115 Q120 120 125 115" stroke="#000000" stroke-width="2" fill="none" stroke-linecap="round"/>
                      <!-- Body (white) -->
                      <ellipse cx="120" cy="165" rx="40" ry="45" fill="#FFFFFF"/>
                      <!-- Chest/neck band (black) -->
                      <ellipse cx="120" cy="145" rx="30" ry="20" fill="#000000"/>
                      <!-- Left arm (black) -->
                      <ellipse cx="85" cy="150" rx="12" ry="25" fill="#000000" transform="rotate(-20 85 150)"/>
                      <!-- Right arm (black) -->
                      <ellipse cx="155" cy="150" rx="12" ry="25" fill="#000000" transform="rotate(20 155 150)"/>
                    </svg>
                  {% endif %}
                </div>
                <div class="dinveda-cart-items__empty-message-wrapper">
                  <p class="dinveda-cart-items__empty-text">{{ empty_message }}</p>
                  {% if button_text != blank and button_link != blank %}
                    <a href="{{ button_link }}" class="button btn-outline btn-secondary dinveda-cart-items__empty-button">
                      {{ button_text }}
                    </a>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      {%- comment -%} Order Summary Sidebar {%- endcomment -%}
      {% if cart.item_count > 0 %}
        <div class="dinveda-cart-items__summary span-12 lg-span-4 auto">
          <div class="dinveda-cart-summary">
            <h3 class="dinveda-cart-summary__title">{{ section.settings.summary_title | default: 'Order Summary' }}</h3>
            
            <div class="dinveda-cart-summary__details">
              <div class="dinveda-cart-summary__row">
                <span class="dinveda-cart-summary__label">{{ 'cart.general.subtotal' | t | upcase }}</span>
                <span class="dinveda-cart-summary__value js-cart-subtotal">{{ cart.items_subtotal_price | money }}</span>
              </div>

              {% if show_shipping %}
                <div class="dinveda-cart-summary__row">
                  <span class="dinveda-cart-summary__label">{{ 'cart.general.shipping' | t | upcase }}</span>
                  <span class="dinveda-cart-summary__value">
                    {% if cart.total_price >= 5000 %}
                      {{ 'cart.general.free_shipping_qualified' | t }}
                    {% else %}
                      {{ 'cart.general.at_checkout' | t }}
                    {% endif %}
                  </span>
                </div>
              {% endif %}

              {% if show_tax_note %}
                <div class="dinveda-cart-summary__row dinveda-cart-summary__row--tax">
                  <span class="dinveda-cart-summary__label dinveda-cart-summary__label--tax">Enthält MwSt. (19%)</span>
                  <span class="dinveda-cart-summary__value dinveda-cart-summary__value--tax">
                    {%- assign tax_amount = cart.total_price | times: 19 | divided_by: 119 -%}
                    {{ tax_amount | money }}
                  </span>
                </div>
              {% endif %}

              {%- if cart.cart_level_discount_applications != blank -%}
                <div class="dinveda-cart-summary__row dinveda-cart-summary__row--discount">
                  <span class="dinveda-cart-summary__label">{{ 'cart.general.discounts' | t | upcase }}</span>
                  <ul class="dinveda-cart-summary__discounts">
                    {%- for discount_application in cart.cart_level_discount_applications -%}
                      <li class="dinveda-cart-summary__discount">
                        {{ discount_application.title }} (-{{ discount_application.total_allocated_amount | money }})
                      </li>
                    {%- endfor -%}
                  </ul>
                </div>
              {%- endif -%}
            </div>

            <div class="dinveda-cart-summary__total">
              <span class="dinveda-cart-summary__total-label">{{ 'cart.general.total' | t | upcase }}</span>
              <span class="dinveda-cart-summary__total-value">
                <span class="cart-original-total cart-price js-cart-total">{{ cart.total_price | money }}</span>
              </span>
            </div>

            <form action="{{ routes.cart_url }}" method="post" novalidate>
              <button type="submit" name="checkout" class="dinveda-cart-summary__checkout-btn">
                {{ checkout_button_label | escape }}
              </button>
            </form>

            {% if show_security_badges %}
              <div class="dinveda-cart-summary__security">
                <p class="dinveda-cart-summary__security-text">{{ section.settings.security_text | default: 'Secure Checkout with SSL Encryption' }}</p>
                <div class="dinveda-cart-summary__security-icons">
                  <span class="material-symbols-outlined">lock</span>
                  <span class="material-symbols-outlined">verified_user</span>
                  <span class="material-symbols-outlined">payments</span>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</section>

{% schema %}
{
  "name": "DinVeda Cart Items",
  "tag": "section",
  "class": "dynamic-section",
  "settings": [
    {
      "type": "text",
      "id": "cart_label",
      "label": "Cart label",
      "default": "YOUR RITUALS"
    },
    {
      "type": "text",
      "id": "summary_title",
      "label": "Summary title",
      "default": "Order Summary"
    },
    {
      "type": "checkbox",
      "id": "show_ritual_timing",
      "label": "Show ritual timing",
      "default": true,
      "info": "Display ritual timing label (MORGEN | AKTIVIEREN, etc.)"
    },
    {
      "type": "checkbox",
      "id": "ritual_timing_fallback_tag",
      "label": "Use product tags as fallback",
      "default": true,
      "info": "If metafield is empty, use product tags (Morgen, Tag, Abend, Balance)"
    },
    {
      "type": "checkbox",
      "id": "show_variant_title",
      "label": "Show variant title",
      "default": true,
      "info": "Display variant name (e.g., '500g Glass Jar')"
    },
    {
      "type": "checkbox",
      "id": "show_shipping",
      "label": "Show shipping",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_tax_note",
      "label": "Show tax note",
      "default": true
    },
    {
      "type": "text",
      "id": "checkout_button_label",
      "label": "Checkout button label",
      "default": "ZUR KASSE"
    },
    {
      "type": "checkbox",
      "id": "show_security_badges",
      "label": "Show security badges",
      "default": true
    },
    {
      "type": "text",
      "id": "security_text",
      "label": "Security text",
      "default": "Secure Checkout with SSL Encryption"
    },
    {
      "type": "header",
      "content": "Empty Cart Settings"
    },
    {
      "type": "text",
      "id": "empty_cart_message",
      "label": "Empty cart message",
      "default": "Dein Warenkorb ist leer"
    },
    {
      "type": "text",
      "id": "empty_cart_button_text",
      "label": "Shop now button text",
      "default": "Jetzt Einkaufen"
    },
    {
      "type": "url",
      "id": "empty_cart_button_link",
      "label": "Shop now button link",
      "default": "/",
      "info": "Default: Homepage"
    },
    {
      "type": "image_picker",
      "id": "empty_cart_fox_image",
      "label": "Animal image",
      "info": "Upload an animal image to display above the empty cart message. The image will appear above the white speech bubble."
    }
  ],
  "presets": [
    {
      "name": "DinVeda Cart Items"
    }
  ]
}
{% endschema %}

