{% comment %}
  DinVeda Main Product Hero Section (DV Template)
  Product hero with buy box - uses description markers and tags (NO metafields)
{% endcomment %}

{%- liquid
  if product
    assign current_variant = product.selected_or_first_available_variant
  else
    assign current_variant = null
  endif
  
  assign product_form_id = 'product-form-' | append: section.id
  
  if product and product.template_suffix == 'pre-order'
    assign call_to_action = 'products.product.pre_order' | t
  elsif product
    assign call_to_action = 'products.product.add_to_cart' | t
  else
    assign call_to_action = 'Add to cart'
  endif

  if current_variant and current_variant.available == false
    assign call_to_action = 'products.product.sold_out' | t
  endif

  # Read from theme editor settings (can be connected to metafields via dynamic source) or fallback values
  assign subtitle = section.settings.subtitle
  assign quote = section.settings.quote
  assign animal_name = section.settings.animal_name
  
  # Read ritual attributes from theme editor settings (can be connected to metafields)
  assign ritual_time = section.settings.ritual_timing
  if ritual_time == blank
    assign ritual_time = section.settings.time_fallback | default: 'Morgen'
  endif
  
  assign ritual_prep = section.settings.preparation_mode
  if ritual_prep == blank
    assign ritual_prep = section.settings.prep_fallback | default: 'Warm'
  endif
  
  assign ritual_duration = section.settings.ritual_duration
  if ritual_duration == blank
    assign ritual_duration = section.settings.duration_fallback | default: '1-2 Min'
  endif
  
  # Trust badges from metaobject list (product metafield)
  assign trust_badges_meta = null
  if product.metafields.custom.dv_trust_badges
    assign trust_badges_meta = product.metafields.custom.dv_trust_badges.value
  endif
-%}

{%- comment -%} Product JSON for Product object initialization {%- endcomment -%}
{% if product %}
  {% render 'product-json', product: product %}
{% endif %}

{%- comment -%} Product form config {%- endcomment -%}
{%- liquid
  assign product_variants_setting = settings.product_variants | default: 'dropdowns'
-%}
{% capture product_form_config %}
{
  "money_format": {{ shop.money_format | json }},
  "enable_history": true,
  "sold_out": {{ "products.product.sold_out" | t | json }},
  "button": {{ call_to_action | json }},
  "unavailable": {{ 'products.product.unavailable' | t | json }},
  "quickview": false,
  "featured_product": false,
  "swatches": {{ product_variants_setting | json }}
}
{% endcapture %}

{% style %}
  #dv-main-product-{{ section.id }} {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
  }
{% endstyle %}

<section
  id="dv-main-product-{{ section.id }}"
  class="dv-main-product"
  data-section-id="{{ section.id }}"
  data-section-type="dv-main-product"
  {% if product %}data-product-id="{{ product.id }}"{% endif %}
  data-asset-url="{{ 'section-product.js' | asset_url }}"
>
  <div class="dv-main-product__container">
    <div class="dv-main-product__grid">
      
      {%- comment -%} Left Column: Product Gallery {%- endcomment -%}
      <div class="dv-main-product__gallery">
        {% if product and product.media.size > 0 %}
          {%- assign featured_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media -%}
          
          {%- comment -%} Main Image {%- endcomment -%}
          <div class="dv-main-product__main-image">
            {% if featured_media %}
              <img
                src="{{ featured_media | image_url: width: 800 }}"
                alt="{{ featured_media.alt | escape }}"
                class="dv-main-product__image"
                data-media-id="{{ featured_media.id }}"
                loading="eager"
                width="{{ featured_media.width }}"
                height="{{ featured_media.height }}"
              >
              {%- comment -%} Image Labels {%- endcomment -%}
              <div class="dv-main-product__image-labels">
                {% if section.settings.show_organic_label %}
                  <span class="dv-main-product__image-label dv-main-product__image-label--organic">ORGANIC</span>
                {% endif %}
                {% if section.settings.show_vegan_label %}
                  <span class="dv-main-product__image-label dv-main-product__image-label--vegan">VEGAN</span>
                {% endif %}
              </div>
            {% endif %}
          </div>

          {%- comment -%} Thumbnails {%- endcomment -%}
          {% if product.media.size > 1 and section.settings.show_thumbnails %}
            <div class="dv-main-product__thumbnails">
              {% for media in product.media limit: 4 %}
                <button
                  type="button"
                  class="dv-main-product__thumbnail {% if forloop.first %}dv-main-product__thumbnail--active{% endif %}"
                  data-media-id="{{ media.id }}"
                  aria-label="View image {{ forloop.index }}"
                >
                  <img
                    src="{{ media | image_url: width: 150 }}"
                    alt="{{ media.alt | escape }}"
                    class="dv-main-product__thumbnail-img"
                    loading="lazy"
                    width="150"
                    height="150"
                  >
                </button>
              {% endfor %}
            </div>
          {% endif %}
        {% else %}
          <div class="dv-main-product__main-image">
            {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
          </div>
        {% endif %}
      </div>

      {%- comment -%} Right Column: Buy Box {%- endcomment -%}
      <div class="dv-main-product__buy-box">
        
        {%- comment -%} Subtitle {%- endcomment -%}
        {% if subtitle != blank %}
          <p class="dv-main-product__subtitle">{{ subtitle | escape }}</p>
        {% endif %}

        {%- comment -%} Product Title {%- endcomment -%}
        {% if product %}
          <h1 class="dv-main-product__title">{{ product.title }}</h1>
        {% else %}
          <h1 class="dv-main-product__title">Product Title</h1>
        {% endif %}

        {%- comment -%} Quote {%- endcomment -%}
        {% if quote != blank %}
          <div class="dv-main-product__quote-card">
            <blockquote class="dv-main-product__quote-text">{{ quote | newline_to_br }}</blockquote>
            {% if animal_name != blank %}
              <cite class="dv-main-product__quote-attribution">{{ animal_name | escape }}</cite>
            {% endif %}
          </div>
        {% endif %}
        
        {%- comment -%} Product Badges/Features (MetaObjects from theme editor, blocks fallback) {%- endcomment -%}
        {%- liquid
          assign has_trust_badges_meta = false
          if trust_badges_meta and trust_badges_meta.size > 0
            assign has_trust_badges_meta = true
          endif
          
          assign has_badge_blocks = false
          if section.blocks.size > 0
            for block in section.blocks
              if block.type == 'product_badge'
                assign has_badge_blocks = true
                break
              endif
            endfor
          endif
        -%}
        
        {% if has_trust_badges_meta or has_badge_blocks %}
          <div class="dv-main-product__badges">
            {%- comment -%} Priority: MetaObjects from theme editor {%- endcomment -%}
            {% if has_trust_badges_meta %}
              {% for trust_badge in trust_badges_meta %}
                <div class="dv-main-product__badge">
                  {% if trust_badge.icon_svg != blank %}
                    <span class="dv-main-product__badge-icon">{{ trust_badge.icon_svg }}</span>
                  {% elsif trust_badge.icon != blank %}
                    <span class="dv-main-product__badge-icon">
                      <img src="{{ trust_badge.icon | image_url: width: 24 }}" alt="" width="24" height="24">
                    </span>
                  {% elsif trust_badge.icon_material != blank %}
                    <span class="dv-main-product__badge-icon">{{ trust_badge.icon_material | escape }}</span>
                  {% endif %}
                  {% if trust_badge.text != blank %}
                    <span class="dv-main-product__badge-text">{{ trust_badge.text | escape }}</span>
                  {% endif %}
                </div>
              {% endfor %}
            {%- comment -%} Fallback: Blocks {%- endcomment -%}
            {% elsif has_badge_blocks %}
              {% for block in section.blocks %}
                {% if block.type == 'product_badge' %}
                  <div class="dv-main-product__badge" {{ block.shopify_attributes }}>
                    {% if block.settings.icon_emoji != blank %}
                      <span class="dv-main-product__badge-emoji">{{ block.settings.icon_emoji | escape }}</span>
                    {% endif %}
                    {% if block.settings.text != blank %}
                      <span class="dv-main-product__badge-text">{{ block.settings.text | escape }}</span>
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            {% endif %}
          </div>
        {% endif %}

        {%- comment -%} Price {%- endcomment -%}
        {% if product and current_variant %}
          <div class="dv-main-product__price-section">
            <div class="dv-main-product__price-wrapper">
              <div class="dv-main-product__price" data-product-price>
                <span data-regular-price>{{ current_variant.price | money }}</span>
                {% if current_variant.compare_at_price > current_variant.price %}
                  <span class="dv-main-product__compare-price" data-compare-price>
                    {{ current_variant.compare_at_price | money }}
                  </span>
                {% endif %}
              </div>
              {% if section.settings.price_note != blank %}
                <span class="dv-main-product__price-note">{{ section.settings.price_note | escape }}</span>
              {% endif %}
            </div>
          </div>

          {%- comment -%} Product Form {%- endcomment -%}
          {% form 'product', product,
            id: product_form_id,
            class: "dv-main-product__form js-prod-form-submit"
          %}
            
            <input type="hidden" name="id" id="formVariantId" value="{{ current_variant.id }}">

            {%- comment -%} Variants {%- endcomment -%}
            {% unless product.has_only_default_variant %}
            <div class="dv-main-product__variants" data-section="{{ section.id }}">
              {% for option in product.options_with_values %}
                <div class="dv-main-product__variant-option">
                  <label class="dv-main-product__variant-label" for="Option-{{ section.id }}-{{ forloop.index0 }}">
                    {{ option.name }}
                  </label>
                  <div class="dv-main-product__variant-select">
                    <select
                      id="Option-{{ section.id }}-{{ forloop.index0 }}"
                      class="js-variant-selector"
                      name="options[{{ option.name | escape }}]"
                    >
                      {% for value in option.values %}
                        <option
                          value="{{ value | escape }}"
                          {% if option.selected_value == value %}selected="selected"{% endif %}
                        >
                          {{ value }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endunless %}

            {%- comment -%} Purchase Controls (Quantity + Buy Button) {%- endcomment -%}
            <div class="dv-main-product__purchase-controls">
              {%- comment -%} Quantity Row (Selector + Stock Status) {%- endcomment -%}
              {% if section.settings.show_quantity %}
                <div class="dv-main-product__quantity-row">
                  <div class="dv-main-product__quantity">
                    <div class="dv-main-product__quantity-selector">
                      <button type="button" class="dv-main-product__quantity-btn" data-quantity-decrease>-</button>
                      <input
                        type="number"
                        id="Quantity-{{ section.id }}"
                        name="quantity"
                        value="1"
                        min="1"
                        class="dv-main-product__quantity-input"
                        data-quantity-input
                      >
                      <button type="button" class="dv-main-product__quantity-btn" data-quantity-increase>+</button>
                    </div>
                  </div>
                  {% if current_variant and current_variant.available %}
                    <span class="dv-main-product__stock-status">In stock</span>
                  {% endif %}
                </div>
              {% endif %}

              {%- comment -%} Buy Now Button {%- endcomment -%}
              <button
                type="button"
                class="dv-main-product__buy-now"
                data-buy-now
                data-variant-id="{{ current_variant.id }}"
                {% unless current_variant.available %}disabled{% endunless %}
              >
                <svg class="dv-main-product__buy-now-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 3H5.5L6.5 10H13L14.5 5H5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                  <circle cx="7" cy="13" r="1" fill="currentColor"/>
                  <circle cx="13" cy="13" r="1" fill="currentColor"/>
                </svg>
                <span>{{ section.settings.buy_now_label | default: "Jetzt kaufen" | escape }}</span>
              </button>
            </div>

          {% endform %}
        {% endif %}

        {%- comment -%} Ritual auf einen Blick (from tags) {%- endcomment -%}
        {% if section.settings.show_ritual_glance %}
          <div class="dv-main-product__ritual-glance">
            <div class="dv-main-product__ritual-glance-item">
              <span class="dv-main-product__ritual-glance-label">Tageszeit</span>
              <span class="dv-main-product__ritual-glance-value">{{ ritual_time | escape }}</span>
            </div>
            <div class="dv-main-product__ritual-glance-item">
              <span class="dv-main-product__ritual-glance-label">Zubereitung</span>
              <span class="dv-main-product__ritual-glance-value">{{ ritual_prep | escape }}</span>
            </div>
            <div class="dv-main-product__ritual-glance-item">
              <span class="dv-main-product__ritual-glance-label">Dauer</span>
              <span class="dv-main-product__ritual-glance-value">{{ ritual_duration | escape }}</span>
            </div>
          </div>
        {% endif %}

        {%- comment -%} Social Share (if enabled) {%- endcomment -%}
        {% if section.settings.show_social_share %}
          <div class="dv-main-product__social-share">
            <span class="dv-main-product__social-label">TEILEN</span>
            <div class="dv-main-product__social-icons">
              <a href="https://www.facebook.com/sharer/sharer.php?u={{ shop.url | append: product.url | url_param_escape }}" target="_blank" rel="noopener" class="dv-main-product__social-icon" aria-label="Share on Facebook">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/>
                </svg>
              </a>
              <a href="https://twitter.com/intent/tweet?url={{ shop.url | append: product.url | url_param_escape }}&text={{ product.title | url_param_escape }}" target="_blank" rel="noopener" class="dv-main-product__social-icon" aria-label="Share on Twitter">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
                </svg>
              </a>
              <a href="https://pinterest.com/pin/create/button/?url={{ shop.url | append: product.url | url_param_escape }}&media={{ product.featured_image | image_url: width: 1200 | url_param_escape }}&description={{ product.title | url_param_escape }}" target="_blank" rel="noopener" class="dv-main-product__social-icon" aria-label="Share on Pinterest">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12c0 4.84 3.44 8.87 8 9.8-.11-.98-.2-2.48.04-3.54.22-.94 1.43-6.35 1.43-6.35s-.36-.72-.36-1.78c0-1.66.96-2.9 2.16-2.9 1.02 0 1.51.77 1.51 1.69 0 1.02-.65 2.55-.99 3.97-.28 1.2.6 2.18 1.78 2.18 2.14 0 3.78-2.26 3.78-5.52 0-2.88-2.07-4.9-5.03-4.9-3.43 0-5.44 2.57-5.44 5.23 0 1.02.39 2.12.88 2.72a.36.36 0 0 1 .08.4l-.33 1.33c-.05.2-.16.24-.37.15-1.38-.64-2.24-2.65-2.24-4.26 0-3.48 2.53-6.68 7.3-6.68 3.83 0 6.8 2.73 6.8 6.38 0 3.8-2.4 6.86-5.86 6.86-1.15 0-2.23-.6-2.6-1.3l-.71 2.7c-.26 1-.96 2.25-1.43 3.01 1.08.33 2.22.51 3.4.51 5.52 0 10-4.48 10-10S17.52 2 12 2z"/>
                </svg>
              </a>
            </div>
          </div>
        {% endif %}

      </div>
    </div>
  </div>
</section>

{%- comment -%} Load product form JS {%- endcomment -%}
<script src="{{ 'product.js' | asset_url }}" defer></script>

<script>
  (function() {
    'use strict';
    
    function initMainProductSection() {
      const section = document.querySelector('#dv-main-product-{{ section.id }}');
      if (!section) return;

      // Gallery thumbnail switching
      const thumbs = section.querySelectorAll('.dv-main-product__thumbnail');
      const mainImage = section.querySelector('.dv-main-product__image');
      
      if (thumbs.length > 0 && mainImage) {
        thumbs.forEach(function(thumb) {
          thumb.addEventListener('click', function() {
            const mediaId = this.getAttribute('data-media-id');
            const thumbImg = this.querySelector('.dv-main-product__thumbnail-img');
            
            if (thumbImg && mediaId) {
              const newSrc = thumbImg.src.replace(/width=\d+/, 'width=800').replace(/_\d+x\d+/, '');
              mainImage.src = newSrc;
              mainImage.setAttribute('data-media-id', mediaId);
              
              thumbs.forEach(function(t) {
                t.classList.remove('dv-main-product__thumbnail--active');
              });
              this.classList.add('dv-main-product__thumbnail--active');
            }
          });
        });
      }

      // Quantity selector and cart integration
      const qtyDecrease = section.querySelector('[data-quantity-decrease]');
      const qtyIncrease = section.querySelector('[data-quantity-increase]');
      const qtyInput = section.querySelector('[data-quantity-input]');
      const variantSelect = section.querySelector('#formVariantId');
      const buyNowBtn = section.querySelector('[data-buy-now]');
      
      // Function to get current variant ID
      function getCurrentVariantId() {
        if (variantSelect) {
          return variantSelect.value;
        }
        return null;
      }
      
      // Function to fetch cart and find variant quantity
      function getCartQuantityForVariant(variantId, callback) {
        fetch('/cart.js')
          .then(function(response) {
            return response.json();
          })
          .then(function(cart) {
            let quantity = 0;
            if (cart && cart.items) {
              const item = cart.items.find(function(item) {
                return item.variant_id === parseInt(variantId, 10);
              });
              if (item) {
                quantity = item.quantity;
              }
            }
            if (callback) callback(quantity);
          })
          .catch(function(error) {
            console.error('Error fetching cart:', error);
            if (callback) callback(0);
          });
      }
      
      // Function to update quantity display
      function updateQuantityDisplay(quantity) {
        // If quantity is 0 from cart, show 1 as default (empty cart means user starts with 1)
        var displayQuantity = quantity > 0 ? quantity : 1;
        if (qtyInput) {
          qtyInput.value = displayQuantity;
        }
        // Enable/disable buttons and buy now button
        if (qtyDecrease) {
          qtyDecrease.disabled = displayQuantity <= 1;
        }
        if (buyNowBtn) {
          buyNowBtn.disabled = false;
        }
      }
      
      // Initialize: Fetch cart and set initial quantity
      function initializeCartQuantity() {
        const variantId = getCurrentVariantId();
        if (variantId) {
          getCartQuantityForVariant(variantId, function(quantity) {
            updateQuantityDisplay(quantity);
          });
        } else {
          // If no variant ID yet, initialize with 1
          updateQuantityDisplay(1);
        }
      }
      
      // Initialize on page load (with slight delay to ensure product.js has run)
      setTimeout(function() {
        initializeCartQuantity();
      }, 100);
      
      // Quantity increase button: Add 1 to cart
      if (qtyIncrease) {
        qtyIncrease.addEventListener('click', function() {
          const variantId = getCurrentVariantId();
          if (!variantId) return;
          
          // Disable button during request
          qtyIncrease.disabled = true;
          
          fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              id: variantId,
              quantity: 1
            })
          })
          .then(function(response) {
            return response.json();
          })
          .then(function(data) {
            // Success - fetch updated cart and update display
            getCartQuantityForVariant(variantId, function(quantity) {
              updateQuantityDisplay(quantity);
              qtyIncrease.disabled = false;
              
              // Trigger cart update event for theme integration
              document.dispatchEvent(new CustomEvent('cart:updated'));
            });
          })
          .catch(function(error) {
            console.error('Error adding to cart:', error);
            qtyIncrease.disabled = false;
          });
        });
      }
      
      // Quantity decrease button: Remove 1 from cart
      if (qtyDecrease && variantSelect) {
        qtyDecrease.addEventListener('click', function() {
          const variantId = getCurrentVariantId();
          if (!variantId) return;
          
          // Disable button during request
          qtyDecrease.disabled = true;
          
          // Fetch cart to get current quantity and item key
          fetch('/cart.js')
            .then(function(response) {
              return response.json();
            })
            .then(function(cart) {
              const item = cart.items.find(function(item) {
                return item.variant_id === parseInt(variantId, 10);
              });
              
              if (!item || item.quantity <= 0) {
                qtyDecrease.disabled = false;
                updateQuantityDisplay(1);
                return;
              }
              
              const newQuantity = item.quantity - 1;
              
              // Update cart using change.js endpoint
              fetch('/cart/change.js', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  id: item.key,
                  quantity: newQuantity
                })
              })
              .then(function(response) {
                return response.json();
              })
              .then(function(data) {
                // Success - update display
                updateQuantityDisplay(newQuantity);
                qtyDecrease.disabled = false;
                
                // Trigger cart update event for theme integration
                document.dispatchEvent(new CustomEvent('cart:updated'));
              })
              .catch(function(error) {
                console.error('Error updating cart:', error);
                qtyDecrease.disabled = false;
              });
            })
            .catch(function(error) {
              console.error('Error fetching cart:', error);
              qtyDecrease.disabled = false;
            });
        });
      }
      
      // Handle variant changes: Update quantity display for new variant
      // Listen to formVariantId change (updated by product.js)
      if (variantSelect) {
        variantSelect.addEventListener('change', function() {
          const variantId = getCurrentVariantId();
          if (variantId) {
            getCartQuantityForVariant(variantId, function(quantity) {
              updateQuantityDisplay(quantity);
            });
          }
        });
      }
      
      // Handle direct input changes (when user types in the input field)
      if (qtyInput) {
        qtyInput.addEventListener('change', function() {
          const variantId = getCurrentVariantId();
          if (!variantId) return;
          
          var inputValue = parseInt(this.value, 10);
          
          // Validate: ensure minimum of 1
          if (isNaN(inputValue) || inputValue < 1) {
            inputValue = 1;
            this.value = inputValue;
          }
          
          // Get current cart quantity for this variant
          getCartQuantityForVariant(variantId, function(currentQuantity) {
            var targetQuantity = inputValue;
            var quantityChange = targetQuantity - currentQuantity;
            
            if (quantityChange === 0) {
              // No change needed, just update display
              updateQuantityDisplay(currentQuantity);
              return;
            }
            
            if (quantityChange > 0) {
              // Add items to cart
              fetch('/cart/add.js', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  id: variantId,
                  quantity: quantityChange
                })
              })
              .then(function(response) {
                return response.json();
              })
              .then(function(data) {
                // Success - fetch updated cart and update display
                getCartQuantityForVariant(variantId, function(quantity) {
                  updateQuantityDisplay(quantity);
                  document.dispatchEvent(new CustomEvent('cart:updated'));
                });
              })
              .catch(function(error) {
                console.error('Error adding to cart:', error);
                // Revert to current cart quantity on error
                updateQuantityDisplay(currentQuantity);
              });
            } else {
              // Remove items from cart (quantityChange is negative)
              var removeQuantity = Math.abs(quantityChange);
              
              // First get current cart item to find its key
              fetch('/cart.js')
                .then(function(response) {
                  return response.json();
                })
                .then(function(cart) {
                  const item = cart.items.find(function(item) {
                    return item.variant_id === parseInt(variantId, 10);
                  });
                  
                  if (!item) {
                    // Item not in cart, reset to 1
                    updateQuantityDisplay(1);
                    return;
                  }
                  
                  var newQuantity = item.quantity - removeQuantity;
                  if (newQuantity < 1) {
                    newQuantity = 1;
                  }
                  
                  // Update cart quantity
                  fetch('/cart/change.js', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                      id: item.key,
                      quantity: newQuantity
                    })
                  })
                  .then(function(response) {
                    return response.json();
                  })
                  .then(function(data) {
                    // Success - update display
                    getCartQuantityForVariant(variantId, function(quantity) {
                      updateQuantityDisplay(quantity);
                      document.dispatchEvent(new CustomEvent('cart:updated'));
                    });
                  })
                  .catch(function(error) {
                    console.error('Error updating cart:', error);
                    // Revert to current cart quantity on error
                    updateQuantityDisplay(currentQuantity);
                  });
                })
                .catch(function(error) {
                  console.error('Error fetching cart:', error);
                  // Revert to current cart quantity on error
                  updateQuantityDisplay(currentQuantity);
                });
            }
          });
        });
        
        // Prevent invalid input (allow only numbers)
        qtyInput.addEventListener('keydown', function(e) {
          // Allow: backspace, delete, tab, escape, enter, decimal point, and numbers
          if ([46, 8, 9, 27, 13, 110, 190].indexOf(e.keyCode) !== -1 ||
            // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
            (e.keyCode === 65 && e.ctrlKey === true) ||
            (e.keyCode === 67 && e.ctrlKey === true) ||
            (e.keyCode === 86 && e.ctrlKey === true) ||
            (e.keyCode === 88 && e.ctrlKey === true) ||
            // Allow: home, end, left, right
            (e.keyCode >= 35 && e.keyCode <= 39)) {
            return;
          }
          // Ensure that it is a number and stop the keypress
          if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
            e.preventDefault();
          }
        });
      }

      // Buy Now button: Redirect to checkout (cart already has items)
      if (buyNowBtn) {
        buyNowBtn.addEventListener('click', function() {
          if (this.disabled) return;
          window.location.href = '/checkout';
        });
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMainProductSection);
    } else {
      initMainProductSection();
    }
  })();
</script>

{% schema %}
{
  "name": "DV Main Product",
  "tag": "section",
  "class": "dynamic-section",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 120,
      "step": 8,
      "unit": "px",
      "default": 80
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 120,
      "step": 8,
      "unit": "px",
      "default": 80
    },
    {
      "type": "checkbox",
      "id": "show_thumbnails",
      "label": "Show thumbnails",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_organic_label",
      "label": "Show organic label",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_vegan_label",
      "label": "Show vegan label",
      "default": true
    },
    {
      "type": "header",
      "content": "Content - Connect to Product Metafields"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_product_subtitle (DV Product Subtitle) or enter text manually"
    },
    {
      "type": "textarea",
      "id": "quote",
      "label": "Quote",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_product_quote (DV Product Quote - Multi-line text) or enter text manually"
    },
    {
      "type": "text",
      "id": "animal_name",
      "label": "Animal Name",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_animal_name (DV Animal Name) or enter text manually. Used for quote attribution."
    },
    {
      "type": "text",
      "id": "price_note",
      "label": "Price note",
      "default": "inkl. MwSt. / 100g Dose"
    },
    {
      "type": "header",
      "content": "Form"
    },
    {
      "type": "checkbox",
      "id": "show_quantity",
      "label": "Show quantity selector",
      "default": true
    },
    {
      "type": "text",
      "id": "add_to_cart_label",
      "label": "Add to cart label",
      "default": "IN DEN WARENKORB"
    },
    {
      "type": "checkbox",
      "id": "enable_buy_now",
      "label": "Enable buy now button",
      "default": true
    },
    {
      "type": "text",
      "id": "buy_now_label",
      "label": "Buy now label",
      "default": "Jetzt kaufen"
    },
    {
      "type": "header",
      "content": "Ritual Attributes - Connect to Product Metafields"
    },
    {
      "type": "checkbox",
      "id": "show_ritual_glance",
      "label": "Show ritual glance row",
      "default": true,
      "info": "Displays Tageszeit, Zubereitung, Dauer"
    },
    {
      "type": "textarea",
      "id": "ritual_timing",
      "label": "Ritual Timing (Tageszeit)",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_ritual_timing (DV Ritual Timing - Multi-line text) or enter text manually"
    },
    {
      "type": "textarea",
      "id": "preparation_mode",
      "label": "Preparation Mode (Zubereitung)",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_preparation_mode (DV Preparation Mode - Multi-line text) or enter text manually"
    },
    {
      "type": "textarea",
      "id": "ritual_duration",
      "label": "Ritual Duration (Dauer)",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_ritual_duration (DV Ritual Duration - Multi-line text) or enter text manually"
    },
    {
      "type": "header",
      "content": "Ritual Attributes - Fallback Values"
    },
    {
      "type": "text",
      "id": "time_fallback",
      "label": "Time fallback",
      "default": "Morgen",
      "info": "Used if Ritual Timing field above is empty"
    },
    {
      "type": "text",
      "id": "prep_fallback",
      "label": "Prep fallback",
      "default": "Warm",
      "info": "Used if Preparation Mode field above is empty"
    },
    {
      "type": "text",
      "id": "duration_fallback",
      "label": "Duration fallback",
      "default": "1-2 Min",
      "info": "Used if Ritual Duration field above is empty"
    },
    {
      "type": "header",
      "content": "Trust Badges"
    },
    {
      "type": "paragraph",
      "content": "‚ö†Ô∏è Configure per product: Go to Products ‚Üí [Your Product] ‚Üí Metafields ‚Üí Find 'DV Trust Badges' ‚Üí Select metaobject instances. This section automatically reads from product.metafields.custom.dv_trust_badges. Alternatively, use blocks below as fallback."
    },
    {
      "type": "header",
      "content": "Social"
    },
    {
      "type": "checkbox",
      "id": "show_social_share",
      "label": "Show social share",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "product_badge",
      "name": "Product Badge (Fallback)",
      "limit": 5,
      "settings": [
        {
          "type": "text",
          "id": "icon_emoji",
          "label": "Icon Emoji",
          "default": "üåø",
          "info": "Emoji icon (e.g., üåø, üå∏, ü•õ, üëê). Used as fallback if product.metafields.custom.dv_trust_badges (DV Trust Badges - list of DV Trust Badge metaobjects) is empty."
        },
        {
          "type": "text",
          "id": "text",
          "label": "Badge Text",
          "default": "100 % Bio & vegan",
          "info": "Used as fallback if product.metafields.custom.dv_trust_badges (DV Trust Badges) is empty."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "DV Main Product"
    }
  ]
}
{% endschema %}

