{% comment %}
  DinVeda Recipe Cards Section (DV Template)
  "Usage Rituals" - Refined grid of recipe-style cards (Golden Milk, Morning Mix, etc.)
  
  Content Source (Hybrid Pattern):
  - Priority: product.metafields.custom.dv_recipe_cards (list of DV Recipe Card metaobjects)
  - Fallback: Blocks in section schema (4 recipe card blocks)
  
  Each recipe card requires: title, description, usage_instruction
{% endcomment %}

{%- liquid
  # Read section heading (can be connected to metafield via dynamic source)
  assign section_heading = section.settings.heading | default: 'Dein t√§gliches Ritual'
  
  # Recipe cards from metaobject list (product metafield)
  assign recipe_cards_meta = null
  assign has_recipe_cards_meta = false
  if product.metafields.custom.dv_recipe_cards
    assign recipe_cards_meta = product.metafields.custom.dv_recipe_cards.value
    if recipe_cards_meta and recipe_cards_meta.size > 0
      assign has_recipe_cards_meta = true
    endif
  endif
  
  # Check for recipe card blocks (fallback)
  assign has_recipe_blocks = false
  if section.blocks.size > 0
    for block in section.blocks
      if block.type == 'recipe_card'
        assign has_recipe_blocks = true
        break
      endif
    endfor
  endif
  
  # Check if we have content to show
  assign has_content = false
  if has_recipe_cards_meta or has_recipe_blocks or section.settings.show_when_empty
    assign has_content = true
  endif
-%}

{% if has_content %}
<section
  id="dv-recipe-cards-{{ section.id }}"
  class="dv-recipe-cards"
  data-section-id="{{ section.id }}"
  data-section-type="dv-recipe-cards"
>
  {% style %}
    #dv-recipe-cards-{{ section.id }} {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
      background-color: var(--dv-bg-beige);
    }
  {% endstyle %}
  
  <div class="dv-recipe-cards__container">
    {%- comment -%} Section Heading (Centered, Italic, Editorial) {%- endcomment -%}
    {% if section_heading != blank %}
      <h2 class="dv-recipe-cards__heading">
        {{ section_heading | escape }}
      </h2>
    {% endif %}
    
    {%- comment -%} Recipe Cards Grid (4-card grid: 2x2 desktop, 1 column mobile) {%- endcomment -%}
    <div class="dv-recipe-cards__grid">
      {%- comment -%} Priority: MetaObjects {%- endcomment -%}
      {% if has_recipe_cards_meta %}
        {% for recipe_card in recipe_cards_meta %}
          <div class="dv-recipe-cards__card">
            {%- comment -%} Card Title {%- endcomment -%}
            {% if recipe_card.title != blank %}
              <h3 class="dv-recipe-cards__card-title">
                {{ recipe_card.title.value | default: recipe_card.title | escape }}
              </h3>
            {% endif %}
            
            {%- comment -%} Card Description (flex layout with usage instruction) {%- endcomment -%}
            <div class="dv-recipe-cards__card-content">
              {% if recipe_card.description != blank or recipe_card.body != blank %}
                {%- liquid
                  assign card_description = recipe_card.description.value | default: recipe_card.description | default: recipe_card.body.value | default: recipe_card.body
                  if card_description != blank
                    assign card_description_parsed = card_description
                    # Try to extract usage instruction from description if separate field doesn't exist
                    if recipe_card.usage_instruction == blank and recipe_card.usage_instruction.value == blank
                      # Check if description contains usage instruction pattern
                      if card_description contains '||'
                        assign desc_parts = card_description | split: '||'
                        assign card_description_parsed = desc_parts[0]
                        if desc_parts.size > 1
                          assign usage_instruction_extracted = desc_parts[1] | strip
                        endif
                      endif
                    endif
                  endif
                -%}
                
                {% if card_description_parsed != blank %}
                  <div class="dv-recipe-cards__card-description rte">
                    {{ card_description_parsed | metafield_tag }}
                  </div>
                {% endif %}
              {% endif %}
              
              {%- comment -%} Usage Instruction (at bottom, bold, uppercase, editorial) {%- endcomment -%}
              {%- liquid
                assign usage_instruction = recipe_card.usage_instruction.value | default: recipe_card.usage_instruction | default: ''
              -%}
              {% if usage_instruction != blank %}
                <div class="dv-recipe-cards__card-instruction">
                  {{ usage_instruction | escape }}
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {%- comment -%} Fallback: Blocks {%- endcomment -%}
      {% elsif has_recipe_blocks %}
        {% for block in section.blocks %}
          {% if block.type == 'recipe_card' %}
            {%- liquid
              assign block_title = block.settings.title
              assign block_description = block.settings.description
              assign block_usage = block.settings.usage_instruction
            -%}
            <div class="dv-recipe-cards__card" {{ block.shopify_attributes }}>
              {%- comment -%} Card Title {%- endcomment -%}
              {% if block_title != blank %}
                <h3 class="dv-recipe-cards__card-title">
                  {{ block_title | escape }}
                </h3>
              {% endif %}
              
              {%- comment -%} Card Description (flex layout with usage instruction) {%- endcomment -%}
              <div class="dv-recipe-cards__card-content">
                {% if block_description != blank %}
                  <div class="dv-recipe-cards__card-description rte">
                    {{ block_description }}
                  </div>
                {% endif %}
                
                {%- comment -%} Usage Instruction (at bottom, bold, uppercase, editorial) {%- endcomment -%}
                {% if block_usage != blank %}
                  <div class="dv-recipe-cards__card-instruction">
                    {{ block_usage | escape }}
                  </div>
                {% endif %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      {% endif %}
    </div>
  </div>
</section>
{% endif %}

{% schema %}
{
  "name": "DV Recipe Cards",
  "tag": "section",
  "class": "dynamic-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Dein t√§gliches Ritual",
      "info": "Click 'Connect dynamic source' to link to a product metafield or enter text manually"
    },
    {
      "type": "paragraph",
      "content": "‚ö†Ô∏è Configure per product: Go to Products ‚Üí [Your Product] ‚Üí Metafields ‚Üí Find 'DV Recipe Cards' ‚Üí Select metaobject instances. This section automatically reads from product.metafields.custom.dv_recipe_cards (List of DV Recipe Card). Alternatively, use blocks below as fallback."
    },
    {
      "type": "checkbox",
      "id": "show_when_empty",
      "label": "Show section even if all markers are empty",
      "default": false
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 120,
      "step": 8,
      "unit": "px",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 120,
      "step": 8,
      "unit": "px",
      "default": 48
    }
  ],
  "blocks": [
    {
      "type": "recipe_card",
      "name": "Recipe Card (Fallback)",
      "limit": 4,
      "settings": [
        {
          "type": "header",
          "content": "Connect to DV Recipe Card MetaObject"
        },
        {
          "type": "paragraph",
          "content": "‚ö†Ô∏è IMPORTANT: Do NOT connect the block source at the block level (the blue MetaObject selector at the top). Instead, connect each field individually using 'Connect dynamic source' on each field below. This ensures all fields (Title, Description, Usage Instruction) remain visible."
        },
        {
          "type": "paragraph",
          "content": "üí° To connect fields to a MetaObject: 1) Click 'Connect dynamic source' (database icon) on each field below, 2) Select the MetaObject instance, 3) Choose the corresponding field. Connect ALL THREE fields: Title ‚Üí title, Description ‚Üí description (or body), Usage Instruction ‚Üí usage_instruction."
        },
        {
          "type": "text",
          "id": "title",
          "label": "Recipe Title",
          "default": "Golden Milk",
          "info": "Title for this recipe card (e.g., 'Golden Milk', 'Morning Mix', 'Winter Baking', 'Kitchen Ritual'). Click 'Connect dynamic source' to link to metaobjects.dv_recipe_card.[handle].title.value, or enter text manually. Used as fallback if product.metafields.custom.dv_recipe_cards is empty."
        },
        {
          "type": "richtext",
          "id": "description",
          "label": "Recipe Description",
          "default": "<p>Beschreibung des Rezepts...</p>",
          "info": "Description text for this recipe card. Click 'Connect dynamic source' to link to metaobjects.dv_recipe_card.[handle].description.value (or body.value), or enter content manually. Used as fallback if product.metafields.custom.dv_recipe_cards is empty."
        },
        {
          "type": "text",
          "id": "usage_instruction",
          "label": "Usage Instruction",
          "default": "WARM TRINKEN",
          "info": "Usage instruction displayed at bottom of card (bold, uppercase, e.g., 'WARM TRINKEN', 'ZUM BACKEN', 'IM M√úSLI'). Click 'Connect dynamic source' to link to metaobjects.dv_recipe_card.[handle].usage_instruction.value, or enter text manually. Used as fallback if product.metafields.custom.dv_recipe_cards is empty."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "DV Recipe Cards",
      "blocks": [
        {
          "type": "recipe_card",
          "settings": {
            "title": "Golden Milk",
            "description": "<p>Kombiniere das Pulver mit warmer Pflanzenmilch und etwas Honig f√ºr ein w√§rmendes Abendritual.</p>",
            "usage_instruction": "WARM TRINKEN"
          }
        },
        {
          "type": "recipe_card",
          "settings": {
            "title": "Morning Mix",
            "description": "<p>Mische das Pulver in dein M√ºsli oder Smoothie f√ºr einen energiegeladenen Start in den Tag.</p>",
            "usage_instruction": "IM M√úSLI"
          }
        },
        {
          "type": "recipe_card",
          "settings": {
            "title": "Winter Baking",
            "description": "<p>Verwende das Pulver als Gew√ºrz in deinem Lieblings-Weihnachtsgeb√§ck f√ºr erdende W√§rme.</p>",
            "usage_instruction": "ZUM BACKEN"
          }
        },
        {
          "type": "recipe_card",
          "settings": {
            "title": "Kitchen Ritual",
            "description": "<p>Integriere das Pulver in deine t√§gliche K√ºchenroutine als Gew√ºrzmischung f√ºr herzhafte Gerichte.</p>",
            "usage_instruction": "IN DER K√úCHE"
          }
        }
      ]
    }
  ]
}
{% endschema %}

