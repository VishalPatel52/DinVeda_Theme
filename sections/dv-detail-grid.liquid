{% comment %}
  DinVeda Detail Grid Section (DV Template)
  "Dein Ritual im Detail" - two-column layout redesigned
  Left: Tradition in der Ayurveda-K√ºche
  Right: Zutaten & Fakten
  
  Metafields Used:
  - custom.dv_detail_left_title: Left column title
  - custom.dv_detail_left_body: Left column intro text
  - custom.dv_facts_title: Right column title (DV Facts Title)
  - custom.dv_first_ingredients: Ingredients list with organic marking
  - custom.dv_allergens_notes: Allergens & Notes content
{% endcomment %}

{%- liquid
  # Layout configuration
  assign layout_mode = section.settings.layout_mode | default: 'both'
  
  # Left Column - Tradition (from theme editor settings, can be connected to metafields)
  assign tradition_title = section.settings.tradition_title
  assign tradition_body_metafield = section.settings.tradition_body
  
  # Right Column - Facts (from theme editor settings, can be connected to metafields)
  assign facts_title = section.settings.facts_title
  
  # First Ingredients (ZUTATEN) (from theme editor settings, can be connected to metafields)
  assign first_ingredients_metafield = section.settings.first_ingredients
  
  # Organic note text
  assign organic_note = section.settings.organic_note | default: '*aus kontrolliert biologischem Anbau'
  
  # Allergens & Notes (from theme editor settings, can be connected to metafields)
  assign allergens_notes_metafield = section.settings.allergens_notes
  
  # Ingredient highlights from metaobject list (product metafield)
  assign ingredient_highlights_meta = null
  assign has_ingredient_highlights_meta = false
  if product.metafields.custom.dv_ingredient_highlights
    assign ingredient_highlights_meta = product.metafields.custom.dv_ingredient_highlights.value
    if ingredient_highlights_meta and ingredient_highlights_meta.size > 0
      assign has_ingredient_highlights_meta = true
    endif
  endif
  
  assign has_ingredient_items = false
  assign has_trust_badges = false
  if section.blocks.size > 0
    for block in section.blocks
      if block.type == 'ingredient_item'
        assign has_ingredient_items = true
      elsif block.type == 'trust_badge'
        assign has_trust_badges = true
      endif
    endfor
  endif
  
  # Determine which columns to show
  assign show_left = false
  assign show_right = false
  if layout_mode == 'both' or layout_mode == 'left'
    if tradition_title != blank or tradition_body_metafield != blank or has_ingredient_highlights_meta or has_ingredient_items
      assign show_left = true
    endif
  endif
  if layout_mode == 'both' or layout_mode == 'right'
    if facts_title != blank or first_ingredients_metafield != blank or allergens_notes_metafield != blank or has_trust_badges
      assign show_right = true
    endif
  endif
  
  # Check if we have content to show
  assign has_content = false
  if tradition_title != blank or tradition_body_metafield != blank or facts_title != blank or first_ingredients_metafield != blank or allergens_notes_metafield != blank or has_ingredient_highlights_meta or has_ingredient_items or has_trust_badges
    assign has_content = true
  endif
-%}

{% if has_content or section.settings.show_when_empty %}
<section
  id="dv-detail-grid-{{ section.id }}"
  class="dv-detail-grid"
  data-section-id="{{ section.id }}"
  data-section-type="dv-detail-grid"
  data-layout-mode="{{ layout_mode }}"
>
  {% style %}
    #dv-detail-grid-{{ section.id }} {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
      {% if section.settings.background_color != blank %}
        background: {{ section.settings.background_color }};
      {% endif %}
    }
    
    {% if layout_mode == 'left' %}
      #dv-detail-grid-{{ section.id }} .dv-detail-grid__layout {
        grid-template-columns: 1fr;
      }
    {% elsif layout_mode == 'right' %}
      #dv-detail-grid-{{ section.id }} .dv-detail-grid__layout {
        grid-template-columns: 1fr;
      }
    {% endif %}
  {% endstyle %}
  
  <div class="dv-detail-grid__container">
    {%- comment -%} Section Heading {%- endcomment -%}
    {% if section.settings.section_heading != blank %}
      <div class="dv-detail-grid__section-heading-wrapper">
        <h2 class="dv-detail-grid__section-heading">{{ section.settings.section_heading | escape }}</h2>
      </div>
    {% endif %}
    
    <div class="dv-detail-grid__layout">
      
      {%- comment -%} Left Column: Tradition in der Ayurveda-K√ºche {%- endcomment -%}
      {% if show_left %}
      <div class="dv-detail-grid__column dv-detail-grid__column--left">
        <div class="dv-detail-grid__card">
          {%- comment -%} Title with icon {%- endcomment -%}
          {% if tradition_title != blank %}
            <div class="dv-detail-grid__tradition-header">
              {% if section.settings.tradition_icon != blank %}
                <div class="dv-detail-grid__tradition-icon">
                  {{ section.settings.tradition_icon | image_url: width: 32 | image_tag: alt: tradition_title, loading: 'lazy', width: 32, height: 32 }}
                </div>
              {% endif %}
              <h2 class="dv-detail-grid__tradition-title">
                {{ tradition_title | escape }}
              </h2>
            </div>
          {% endif %}
          
          {%- comment -%} Introductory text {%- endcomment -%}
          {% if tradition_body_metafield != blank %}
            <div class="dv-detail-grid__tradition-intro rte">
              {{ tradition_body_metafield }}
            </div>
          {% endif %}
          
          {%- comment -%} Ingredient Highlights: Priority = product.metafields.custom.dv_ingredient_highlights (per-product), Fallback = theme editor blocks (global) {%- endcomment -%}
          {% if has_ingredient_highlights_meta or has_ingredient_items %}
            <div class="dv-detail-grid__ingredient-highlights">
              {%- comment -%} Priority: MetaObjects {%- endcomment -%}
              {% if has_ingredient_highlights_meta %}
                {% for highlight in ingredient_highlights_meta %}
                  <div class="dv-detail-grid__ingredient-highlight">
                    {% if highlight.icon != blank %}
                      <div class="dv-detail-grid__ingredient-highlight-icon">
                        {{ highlight.icon | image_url: width: 32 | image_tag: alt: highlight.name, loading: 'lazy', width: 32, height: 32 }}
                      </div>
                    {% endif %}
                    <div class="dv-detail-grid__ingredient-highlight-content">
                      {% if highlight.name != blank %}
                        <strong class="dv-detail-grid__ingredient-highlight-name">{{ highlight.name.value | default: highlight.name | escape }}</strong>
                      {% endif %}
                      {% if highlight.description != blank %}
                        <div class="dv-detail-grid__ingredient-highlight-desc rte">
                          {{ highlight.description.value | default: highlight.description | metafield_tag }}
                        </div>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              {%- comment -%} Fallback: Blocks {%- endcomment -%}
              {% elsif has_ingredient_items %}
                {% for block in section.blocks %}
                  {% if block.type == 'ingredient_item' %}
                    {%- liquid
                      # Get icon from block settings (can be connected to MetaObject via dynamic source)
                      # When connected to MetaObject, this will be the MetaObject's icon field
                      assign block_icon = block.settings.icon
                      
                      # Get name from block settings (can be connected to MetaObject via dynamic source)
                      # When connected to MetaObject, this will be the MetaObject's name field
                      assign block_name = block.settings.name
                      
                      # Get description from block settings (can be connected to MetaObject via dynamic source)
                      # When connected to MetaObject, this will be the MetaObject's description field
                      # ‚ö†Ô∏è IMPORTANT: When connecting this block to a DV Ingredient Highlight MetaObject,
                      # make sure to connect ALL THREE fields: Icon, Name, and Description
                      assign block_description = block.settings.description
                    -%}
                    <div class="dv-detail-grid__ingredient-highlight" {{ block.shopify_attributes }}>
                      {% if block_icon != blank %}
                        <div class="dv-detail-grid__ingredient-highlight-icon">
                          {{ block_icon | image_url: width: 32 | image_tag: alt: block_name, loading: 'lazy', width: 32, height: 32 }}
                        </div>
                      {% endif %}
                      <div class="dv-detail-grid__ingredient-highlight-content">
                        {% if block_name != blank %}
                          <strong class="dv-detail-grid__ingredient-highlight-name">{{ block_name | escape }}</strong>
                        {% endif %}
                        {% if block_description != blank %}
                          <p class="dv-detail-grid__ingredient-highlight-desc">{{ block_description | strip_html | escape }}</p>
                        {% endif %}
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
      {% endif %}
      
      {%- comment -%} Right Column: Zutaten & Fakten {%- endcomment -%}
      {% if show_right %}
      <div class="dv-detail-grid__column dv-detail-grid__column--right">
        <div class="dv-detail-grid__card">
          {%- comment -%} Title with icon {%- endcomment -%}
          {% if facts_title != blank %}
            <div class="dv-detail-grid__facts-header">
              {% if section.settings.facts_icon != blank %}
                <div class="dv-detail-grid__facts-icon">
                  {{ section.settings.facts_icon | image_url: width: 32 | image_tag: alt: facts_title, loading: 'lazy', width: 32, height: 32 }}
                </div>
              {% endif %}
              <h2 class="dv-detail-grid__facts-title">
                {{ facts_title | escape }}
              </h2>
            </div>
          {% endif %}
          
          {%- comment -%} ZUTATEN Section (Vollst√§ndige Zutatenliste) {%- endcomment -%}
          {% if first_ingredients_metafield != blank %}
            <div class="dv-detail-grid__zutaten-section">
              <div class="dv-detail-grid__zutaten-content rte">
                {{ first_ingredients_metafield }}
              </div>
              {% if organic_note != blank %}
                <p class="dv-detail-grid__zutaten-note">{{ organic_note | escape }}</p>
              {% endif %}
            </div>
          {% endif %}
          
          {%- comment -%} EU Bio Badges Section (DE-√ñKO-006, Nicht-EU Landwirtschaft) - Below ingredients {%- endcomment -%}
          {% if section.settings.show_eu_bio_badges %}
            <div class="dv-detail-grid__eu-bio-badges" style="{% if section.settings.eu_bio_badges_bg_color != blank %}background: {{ section.settings.eu_bio_badges_bg_color }};{% else %}background-color: rgba(243, 233, 220, 0.5);{% endif %}">
              {% if section.settings.eu_bio_code != blank %}
                <div class="dv-detail-grid__eu-bio-badge">
                  <span class="material-symbols-outlined">eco</span>
                  <span class="dv-detail-grid__eu-bio-label">{{ section.settings.eu_bio_code | escape }}</span>
                </div>
              {% endif %}
              {% if section.settings.eu_non_eu_label != blank %}
                <div class="dv-detail-grid__eu-bio-badge">
                  <span class="material-symbols-outlined">public</span>
                  <span class="dv-detail-grid__eu-bio-label">{{ section.settings.eu_non_eu_label | escape }}</span>
                </div>
              {% endif %}
            </div>
          {% endif %}
          
          {%- comment -%} ALLERGENE & HINWEISE Section {%- endcomment -%}
          {% if allergens_notes_metafield != blank %}
            <div class="dv-detail-grid__allergens-section">
              <h3 class="dv-detail-grid__allergens-title">Allergene & Hinweise</h3>
              <div class="dv-detail-grid__allergens-content rte">
                {{ allergens_notes_metafield }}
              </div>
            </div>
          {% endif %}
          
          {%- comment -%} Trust Badges (in box at bottom) {%- endcomment -%}
          {% if has_trust_badges %}
            <div class="dv-detail-grid__trust-badges" style="{% if section.settings.trust_badges_bg_color != blank %}background: {{ section.settings.trust_badges_bg_color }};{% endif %}">
              {% for block in section.blocks %}
                {% if block.type == 'trust_badge' %}
                  <div class="dv-detail-grid__trust-badge" style="{% if block.settings.background_color != blank %}background: {{ block.settings.background_color }};{% endif %}" {{ block.shopify_attributes }}>
                    {% if block.settings.icon != blank %}
                      <div class="dv-detail-grid__trust-badge-icon">
                        {{ block.settings.icon | image_url: width: 24 | image_tag: alt: block.settings.label, loading: 'lazy', width: 24, height: 24 }}
                      </div>
                    {% endif %}
                    {% if block.settings.label != blank %}
                      <span class="dv-detail-grid__trust-badge-label">{{ block.settings.label | escape }}</span>
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
      {% endif %}
      
    </div>
  </div>
</section>
{% endif %}

{% schema %}
{
  "name": "DV Detail Grid",
  "tag": "section",
  "class": "dynamic-section",
  "settings": [
    {
      "type": "header",
      "content": "Section Heading"
    },
    {
      "type": "text",
      "id": "section_heading",
      "label": "Section Heading",
      "default": "Dein Ritual im Detail",
      "info": "Optional heading displayed above the detail grid (leave empty to hide)"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "layout_mode",
      "label": "Column Layout",
      "options": [
        {
          "value": "both",
          "label": "Both Columns"
        },
        {
          "value": "left",
          "label": "Left Column Only"
        },
        {
          "value": "right",
          "label": "Right Column Only"
        }
      ],
      "default": "both",
      "info": "Select which columns to display"
    },
    {
      "type": "header",
      "content": "Left Column - Tradition"
    },
    {
      "type": "image_picker",
      "id": "tradition_icon",
      "label": "Tradition Icon",
      "info": "Icon displayed next to tradition title"
    },
    {
      "type": "header",
      "content": "Left Column - Connect to Product Metafields"
    },
    {
      "type": "text",
      "id": "tradition_title",
      "label": "Tradition Title",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_detail_left_title (DV Detail Left Title) or enter text manually"
    },
    {
      "type": "richtext",
      "id": "tradition_body",
      "label": "Tradition Intro Text",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_detail_left_body (DV Detail Left Body - Rich text) or enter content manually"
    },
    {
      "type": "header",
      "content": "Right Column - Connect to Product Metafields"
    },
    {
      "type": "image_picker",
      "id": "facts_icon",
      "label": "Facts Icon",
      "info": "Icon displayed next to facts title"
    },
    {
      "type": "text",
      "id": "facts_title",
      "label": "Facts Title",
      "default": "Zutaten & Fakten",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_facts_title (DV Facts Title) or enter text manually"
    },
    {
      "type": "header",
      "content": "EU Bio Badges"
    },
    {
      "type": "checkbox",
      "id": "show_eu_bio_badges",
      "label": "Show EU Bio Badges",
      "default": false,
      "info": "Display EU Bio certification badges (DE-√ñKO-006, Nicht-EU Landwirtschaft) in right column"
    },
    {
      "type": "text",
      "id": "eu_bio_code",
      "label": "EU Bio Code",
      "default": "DE-√ñKO-006",
      "info": "EU Bio certification code (e.g., 'DE-√ñKO-006')"
    },
    {
      "type": "text",
      "id": "eu_non_eu_label",
      "label": "Non-EU Agriculture Label",
      "default": "Nicht-EU Landwirtschaft",
      "info": "Label for non-EU agriculture (e.g., 'Nicht-EU Landwirtschaft')"
    },
    {
      "type": "color_background",
      "id": "eu_bio_badges_bg_color",
      "label": "EU Bio Badges Background Color",
      "default": "#F3E9DC",
      "info": "Background color for the EU Bio badges container (supports rgba/transparency)"
    },
    {
      "type": "header",
      "content": "Ingredients List"
    },
    {
      "type": "text",
      "id": "zutaten_heading",
      "label": "Ingredients Heading",
      "default": "Vollst√§ndige Zutatenliste",
      "info": "Heading for ingredients list (e.g., 'Vollst√§ndige Zutatenliste' or 'Zutaten')"
    },
    {
      "type": "richtext",
      "id": "first_ingredients",
      "label": "Ingredients List",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_first_ingredients (DV First Ingredients - Rich text) or enter content manually"
    },
    {
      "type": "text",
      "id": "organic_note",
      "label": "Organic Note Text",
      "default": "*aus kontrolliert biologischem Anbau",
      "info": "Text displayed below ingredients list (e.g., '*aus kontrolliert biologischem Anbau' or '*aus √∂kologischem Landbau')"
    },
    {
      "type": "richtext",
      "id": "allergens_notes",
      "label": "Allergens & Notes",
      "info": "Click 'Connect dynamic source' to link to product.metafields.custom.dv_allergens_notes (DV Allergens & Notes - Rich text) or enter content manually"
    },
    {
      "type": "header",
      "content": "Ingredient Highlights"
    },
    {
      "type": "paragraph",
      "content": "‚ö†Ô∏è PER-PRODUCT CONFIGURATION (Recommended): Go to Products ‚Üí [Your Product] ‚Üí Metafields ‚Üí Find 'DV Ingredient Highlights' ‚Üí Select metaobject instances. This section automatically reads from product.metafields.custom.dv_ingredient_highlights (List of DV Ingredient Highlight metaobjects). The product metafield takes PRIORITY - if configured, it will override any blocks set in the theme editor below. Blocks are only used as fallback when the product metafield is empty."
    },
    {
      "type": "checkbox",
      "id": "show_when_empty",
      "label": "Show section even if all markers are empty",
      "default": false
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 120,
      "step": 8,
      "unit": "px",
      "default": 48
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 120,
      "step": 8,
      "unit": "px",
      "default": 48
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_background",
      "id": "background_color",
      "label": "Section Background Color",
      "info": "Background color for the entire section (supports rgba/transparency)"
    },
    {
      "type": "color_background",
      "id": "trust_badges_bg_color",
      "label": "Trust Badges Container Background Color",
      "info": "Background color for the trust badges container (supports rgba/transparency). Leave empty for transparent."
    }
  ],
  "blocks": [
    {
      "type": "ingredient_item",
      "name": "Ingredient (Fallback)",
      "settings": [
        {
          "type": "header",
          "content": "Connect to DV Ingredient Highlight MetaObject"
        },
        {
          "type": "paragraph",
          "content": "‚ö†Ô∏è IMPORTANT: Do NOT connect the block source at the block level (the blue MetaObject selector at the top). Instead, connect each field individually using 'Connect dynamic source' on each field below. This ensures all three fields (Icon, Name, Description) remain visible. If you connect the block source, unmapped fields will disappear."
        },
        {
          "type": "paragraph",
          "content": "üí° To connect fields to a MetaObject: 1) Click 'Connect dynamic source' (database icon) on each field below, 2) Select the MetaObject instance, 3) Choose the corresponding field. Connect ALL THREE fields: Icon ‚Üí icon, Name ‚Üí name, Description ‚Üí description."
        },
        {
          "type": "image_picker",
          "id": "icon",
          "label": "Ingredient Icon",
          "info": "Icon for this ingredient. Click 'Connect dynamic source' to link to metaobjects.dv_ingredient_highlight.[handle].icon.value, or upload an image manually. Used as fallback if product.metafields.custom.dv_ingredient_highlights is empty."
        },
        {
          "type": "text",
          "id": "name",
          "label": "Ingredient Name",
          "default": "Kurkuma",
          "info": "Name of the ingredient. Click 'Connect dynamic source' to link to metaobjects.dv_ingredient_highlight.[handle].name.value, or enter text manually. Used as fallback if product.metafields.custom.dv_ingredient_highlights is empty."
        },
        {
          "type": "richtext",
          "id": "description",
          "label": "Ingredient Description",
          "default": "<p>Das \"Gold des Ayurveda\". W√§rmend und erdend.</p>",
          "info": "Short description text for this ingredient (multi-line). Click 'Connect dynamic source' to link to metaobjects.dv_ingredient_highlight.[handle].description.value (MetaObject field type: Multi-line text). The 'richtext' type is compatible with MetaObject multi-line text fields and supports dynamic sources. Used as fallback if product.metafields.custom.dv_ingredient_highlights is empty. ‚ö†Ô∏è IMPORTANT: Make sure to connect this field when mapping a MetaObject!"
        }
      ]
    },
    {
      "type": "trust_badge",
      "name": "Trust Badge",
      "settings": [
        {
          "type": "image_picker",
          "id": "icon",
          "label": "Badge Icon",
          "info": "Icon for trust badge (e.g., leaf, flag, box, checkmark)"
        },
        {
          "type": "text",
          "id": "label",
          "label": "Badge Label",
          "default": "BIO-Zertifiziert",
          "info": "Text label for trust badge"
        },
        {
          "type": "color_background",
          "id": "background_color",
          "label": "Background Color",
          "info": "Background color for this individual trust badge (supports rgba/transparency)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "DV Detail Grid",
      "blocks": [
        {
          "type": "ingredient_item",
          "settings": {
            "name": "Kurkuma",
            "description": "<p>Das \"Gold des Ayurveda\". W√§rmend und erdend.</p>"
          }
        },
        {
          "type": "ingredient_item",
          "settings": {
            "name": "Maca",
            "description": "<p>Traditionell f√ºr Ausdauer und Energie.</p>"
          }
        },
        {
          "type": "ingredient_item",
          "settings": {
            "name": "Ingwer",
            "description": "<p>F√ºr das innere Feuer (Agni).</p>"
          }
        }
      ]
    }
  ]
}
{% endschema %}
