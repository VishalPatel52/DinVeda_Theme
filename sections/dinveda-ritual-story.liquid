{% comment %}
  DinVeda Ritual Story - Story section matching code.html structure
  Flow: Intro paragraphs → "Warum..." heading → Why text → Bullet list → Closing
{% endcomment %}

{%- liquid
  # Story content: blend_story (primary) or ritual_story, fallback to product.description
  assign story_intro = product.metafields.dinveda.blend_story | default: product.metafields.dinveda.ritual_story
  if story_intro == blank
    assign story_intro = product.description
  endif
  
  # Animal name for auto-generating heading
  assign tier_name = product.metafields.dinveda.tier_name | default: product.metafields.dinveda.animal_name
  
  # "Warum der {animal}?" heading - auto-generate from animal name
  assign story_title = section.settings.story_title_override
  if story_title == blank
    assign story_title = product.metafields.dinveda.ritual_story_title
  endif
  if story_title == blank and tier_name != blank
    assign story_title = 'Warum der ' | append: tier_name | append: '?'
  elsif story_title == blank
    assign story_title = 'Warum der ' | append: product.title | append: '?'
  endif
  
  # Check if we have content to show
  assign has_content = false
  if story_intro != blank or story_title != blank
    assign has_content = true
  endif
-%}

{% if has_content or section.settings.show_when_empty %}
  <section
    id="dinveda-ritual-story-{{ section.id }}"
    class="dinveda-ritual-story"
    data-section-id="{{ section.id }}"
    data-section-type="dinveda-ritual-story"
  >
    {%- liquid
      assign watermark_image = section.settings.watermark_image
    -%}
    {% if section.settings.enable_watermark and watermark_image != blank %}
      {% style %}
        #dinveda-ritual-story-{{ section.id }}::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-image: url('{{ watermark_image | image_url: width: 1200 }}');
          background-size: cover;
          background-position: center;
          background-repeat: no-repeat;
          opacity: 0.05;
          pointer-events: none;
          z-index: 0;
        }
      {% endstyle %}
    {% endif %}
    
    {% style %}
      #dinveda-ritual-story-{{ section.id }} {
        padding-top: {{ section.settings.padding_top }}px;
        padding-bottom: {{ section.settings.padding_bottom }}px;
      }
    {% endstyle %}
    
    <div class="dinveda-ritual-story__container">
      <div class="dinveda-ritual-story__content">
        
        {% if section.settings.eyebrow != blank %}
          <p class="dinveda-ritual-story__eyebrow">{{ section.settings.eyebrow | escape }}</p>
        {% endif %}

        {%- comment -%} Intro paragraphs (lead text) {%- endcomment -%}
        {% if story_intro != blank %}
          <div class="dinveda-ritual-story__intro">
            {{ story_intro }}
          </div>
        {% elsif section.settings.intro_fallback != blank %}
          <div class="dinveda-ritual-story__intro">
            {{ section.settings.intro_fallback }}
          </div>
        {% endif %}

        {%- comment -%} "Warum der {animal}?" heading {%- endcomment -%}
        {% if story_title != blank %}
          <h2 class="dinveda-ritual-story__title">{{ story_title | escape }}</h2>
        {% endif %}
        
        {%- comment -%} Story body content {%- endcomment -%}
        {% if story_intro != blank %}
          <div class="dinveda-ritual-story__body">
            {{ story_intro }}
          </div>
        {% elsif section.settings.intro_fallback != blank %}
          <div class="dinveda-ritual-story__body">
            {{ section.settings.intro_fallback }}
          </div>
        {% endif %}

      </div>
    </div>
  </section>
{% endif %}

{% schema %}
{
  "name": "DinVeda Ritual Story",
  "tag": "section",
  "class": "dynamic-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "eyebrow",
      "label": "Eyebrow label",
      "default": "DIE RITUAL-STORY"
    },
    {
      "type": "text",
      "id": "story_title_override",
      "label": "Story Title Override",
      "info": "Optional: Override auto-generated 'Warum der {animal}?' title. Leave blank to auto-generate from product.metafields.dinveda.tier_name"
    },
    {
      "type": "richtext",
      "id": "intro_fallback",
      "label": "Story Content (fallback)",
      "info": "Used if product.metafields.dinveda.blend_story and ritual_story are empty"
    },
    {
      "type": "checkbox",
      "id": "show_when_empty",
      "label": "Show section even if all metafields are empty",
      "default": false
    },
    {
      "type": "header",
      "content": "Background"
    },
    {
      "type": "checkbox",
      "id": "enable_watermark",
      "label": "Enable watermark",
      "default": false
    },
    {
      "type": "image_picker",
      "id": "watermark_image",
      "label": "Watermark image",
      "info": "Optional decorative watermark or animal silhouette (shown at low opacity)"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 120,
      "step": 8,
      "unit": "px",
      "default": 80
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 120,
      "step": 8,
      "unit": "px",
      "default": 80
    }
  ],
  "presets": [
    {
      "name": "DinVeda Ritual Story"
    }
  ]
}
{% endschema %}
