{% comment %}
  DinVeda Product Hero - Premium product page hero section
  Two-column layout: left media, right content with quote card
{% endcomment %}

<link rel="preload" href="{{ 'dinveda-product.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="{{ 'dinveda-product.css' | asset_url }}"></noscript>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const thumbs = document.querySelectorAll('.dinveda-product-hero__gallery-thumb');
    const mainImage = document.querySelector('.dinveda-product-hero__image');
    
    if (thumbs.length > 0 && mainImage) {
      thumbs.forEach(function(thumb) {
        thumb.addEventListener('click', function() {
          const thumbImg = this.querySelector('.dinveda-product-hero__gallery-thumb-img');
          const mediaId = this.getAttribute('data-media-id');
          
          if (thumbImg && mediaId) {
            // Get the full-size image URL
            const thumbSrc = thumbImg.src;
            const newSrc = thumbSrc.replace(/width=\d+/, 'width=800').replace(/_\d+x\d+/, '');
            mainImage.src = newSrc;
            mainImage.setAttribute('data-media-id', mediaId);
            
            // Update active state
            thumbs.forEach(function(t) {
              t.classList.remove('dinveda-product-hero__gallery-thumb--active');
            });
            this.classList.add('dinveda-product-hero__gallery-thumb--active');
          }
        });
      });
    }
  });
</script>

{%- liquid
  assign featured_image = product.featured_image | default: product.images.first
  # Support both old and new metafield names
  assign phase_label = product.metafields.dinveda.phase_label | default: product.metafields.dinveda.ritual_timing_label | default: section.settings.phase_label_fallback
  assign quote = product.metafields.dinveda.quote | default: product.metafields.dinveda.tier_quote | default: product.metafields.dinveda.animal_quote | default: section.settings.quote_fallback
  assign quote_author = product.metafields.dinveda.quote_author | default: product.metafields.dinveda.tier_name | default: product.metafields.dinveda.animal_name | default: section.settings.quote_author_fallback
  assign blend_story_short = product.metafields.dinveda.blend_story_short | default: product.description | truncate: 200
  assign current_variant = product.selected_or_first_available_variant
  assign weight_unit = current_variant.weight_in_unit | default: '100g'
-%}

<section
  id="dinveda-product-hero-{{ section.id }}"
  class="dinveda-product-hero"
  data-section-id="{{ section.id }}"
  data-section-type="dinveda-product-hero"
>
  <div class="dinveda-product-hero__container">
    
    {%- comment -%} Breadcrumb (optional) {%- endcomment -%}
    {% if section.settings.show_breadcrumb %}
      <nav class="dinveda-product-hero__breadcrumb" aria-label="Breadcrumb">
        <a href="{{ routes.root_url }}">Shop</a>
        <span class="dinveda-product-hero__breadcrumb-separator">|</span>
        {% if product.collections.size > 0 %}
          <a href="{{ product.collections.first.url }}">{{ product.collections.first.title }}</a>
          <span class="dinveda-product-hero__breadcrumb-separator">|</span>
        {% endif %}
        <span class="dinveda-product-hero__breadcrumb-current">{{ product.title }}</span>
      </nav>
    {% endif %}
    
    <div class="dinveda-product-hero__grid">
      
      {%- comment -%} Left: Product Media {%- endcomment -%}
      <div class="dinveda-product-hero__media-column">
        {% if featured_image != blank %}
          <div class="dinveda-product-hero__image-wrapper">
            {% assign main_media = product.featured_media | default: product.media.first %}
            {{ main_media | image_url: width: 800 | image_tag: alt: main_media.alt | default: product.title, loading: 'eager', class: 'dinveda-product-hero__image', data-media-id: main_media.id }}
            
            {%- comment -%} Badges {%- endcomment -%}
            {% if section.settings.badge_1_label != blank or section.settings.badge_2_label != blank %}
              <div class="dinveda-product-hero__badges">
                {% if section.settings.badge_1_label != blank %}
                  <span class="dinveda-product-hero__badge">{{ section.settings.badge_1_label | escape }}</span>
                {% endif %}
                {% if section.settings.badge_2_label != blank %}
                  <span class="dinveda-product-hero__badge">{{ section.settings.badge_2_label | escape }}</span>
                {% endif %}
              </div>
            {% endif %}
          </div>
          
          {%- comment -%} Image Gallery Thumbnails {%- endcomment -%}
          {% if product.media.size > 1 %}
            <div class="dinveda-product-hero__gallery">
              <div class="dinveda-product-hero__gallery-thumbnails">
                {% for media in product.media limit: 6 %}
                  {% if media.media_type == 'image' %}
                    <button 
                      type="button"
                      class="dinveda-product-hero__gallery-thumb {% if forloop.first %}dinveda-product-hero__gallery-thumb--active{% endif %}"
                      data-media-id="{{ media.id }}"
                      aria-label="View image {{ forloop.index }}"
                    >
                      {{ media | image_url: width: 100 | image_tag: alt: media.alt | default: product.title, loading: 'lazy', class: 'dinveda-product-hero__gallery-thumb-img' }}
                    </button>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endif %}
        {% else %}
          <div class="dinveda-product-hero__image-wrapper dinveda-product-hero__placeholder">
            {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
          </div>
        {% endif %}
      </div>

      {%- comment -%} Right: Product Content {%- endcomment -%}
      <div class="dinveda-product-hero__content-column">
        <div class="dinveda-product-hero__content">
          
          {%- comment -%} Phase Label {%- endcomment -%}
          {% if phase_label != blank %}
            <p class="dinveda-product-hero__timing-label">{{ phase_label | escape }}</p>
          {% endif %}

          {%- comment -%} Product Title {%- endcomment -%}
          <h1 class="dinveda-product-hero__title">{{ product.title | escape }}</h1>

          {%- comment -%} Quote Card {%- endcomment -%}
          {% if quote != blank or quote_author != blank %}
            <div class="dinveda-product-hero__quote-card">
              {% if quote != blank %}
                <p class="dinveda-product-hero__quote-text">{{ quote }}</p>
              {% endif %}
              {% if quote_author != blank %}
                <p class="dinveda-product-hero__quote-attribution">— sagt der {{ quote_author | escape }}</p>
              {% endif %}
            </div>
          {% endif %}

          {%- comment -%} Short Intro {%- endcomment -%}
          {% if blend_story_short != blank %}
            <div class="dinveda-product-hero__intro">
              {% if blend_story_short contains '<p>' %}
                {{ blend_story_short }}
              {% else %}
                <p>{{ blend_story_short }}</p>
              {% endif %}
            </div>
          {% endif %}

          {%- comment -%} Price {%- endcomment -%}
          <div class="dinveda-product-hero__price">
            <span class="dinveda-product-hero__price-amount">{{ current_variant.price | money }}</span>
            {%- liquid
              assign price_suffix = section.settings.price_suffix
              if price_suffix == blank
                assign price_suffix = 'inkl. MwSt. / ' | append: weight_unit | append: ' Dose'
              elsif price_suffix contains '{{ product.selected_or_first_available_variant.weight_in_unit }}'
                assign price_suffix = price_suffix | replace: '{{ product.selected_or_first_available_variant.weight_in_unit }}', weight_unit
              endif
            -%}
            <span class="dinveda-product-hero__price-suffix">{{ price_suffix | escape }}</span>
          </div>

          {%- comment -%} Add to Cart Form {%- endcomment -%}
          {% form 'product', product, id: 'dinveda-product-hero-form', class: 'dinveda-product-hero__form' %}
            <input type="hidden" name="id" value="{{ current_variant.id }}">
            <button
              type="submit"
              name="add"
              class="dinveda-product-hero__atc-button button btn-solid"
              {% unless current_variant.available %}disabled{% endunless %}
            >
              {% if current_variant.available %}
                {{ section.settings.atc_button_label | default: 'In den Warenkorb' }}
              {% else %}
                {{ 'products.product.sold_out' | t }}
              {% endif %}
            </button>
          {% endform %}

          {% if section.settings.shipping_note != blank %}
            <p class="dinveda-product-hero__shipping-note">{{ section.settings.shipping_note | escape }}</p>
          {% endif %}

          {%- comment -%} Trust Row {%- endcomment -%}
          {% if section.blocks.size > 0 %}
            <div class="dinveda-product-hero__trust-row">
              {% for block in section.blocks %}
                {% if block.type == 'trust_item' %}
                  <div class="dinveda-product-hero__trust-item" {{ block.shopify_attributes }}>
                    {% if block.settings.icon_svg != blank %}
                      <div class="dinveda-product-hero__trust-icon">
                        {{ block.settings.icon_svg }}
                      </div>
                    {% endif %}
                    {% if block.settings.text != blank %}
                      <span class="dinveda-product-hero__trust-text">{{ block.settings.text | escape }}</span>
                    {% endif %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}

        </div>
      </div>

    </div>
  </div>
</section>

{% style %}
  #dinveda-product-hero-{{ section.id }} {
    background-color: var(--design-bg-color, #FFF0DD);
  }
{% endstyle %}

{% schema %}
{
  "name": "DinVeda Product Hero",
  "tag": "section",
  "class": "dynamic-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "checkbox",
      "id": "show_breadcrumb",
      "label": "Show breadcrumb",
      "default": true
    },
    {
      "type": "text",
      "id": "phase_label_fallback",
      "label": "Phase label (fallback)",
      "default": "MORGEN | AKTIVIEREN",
      "info": "Used if product metafield dinveda.phase_label is not set"
    },
    {
      "type": "textarea",
      "id": "quote_fallback",
      "label": "Quote text (fallback)",
      "info": "Used if product metafield dinveda.quote is not set"
    },
    {
      "type": "text",
      "id": "quote_author_fallback",
      "label": "Quote author (fallback)",
      "info": "Used if product metafield dinveda.quote_author is not set"
    },
    {
      "type": "text",
      "id": "badge_1_label",
      "label": "Badge 1 label",
      "default": "BIO"
    },
    {
      "type": "text",
      "id": "badge_2_label",
      "label": "Badge 2 label",
      "default": "VEGAN"
    },
    {
      "type": "text",
      "id": "price_suffix",
      "label": "Price suffix",
      "default": "inkl. MwSt. / {{ product.selected_or_first_available_variant.weight_in_unit }} Dose",
      "info": "Use {{ product.selected_or_first_available_variant.weight_in_unit }} as placeholder for weight"
    },
    {
      "type": "text",
      "id": "atc_button_label",
      "label": "Add to cart button label",
      "default": "In den Warenkorb"
    },
    {
      "type": "text",
      "id": "shipping_note",
      "label": "Shipping note",
      "default": "Kostenloser Versand ab 50€ innerhalb DE"
    }
  ],
  "blocks": [
    {
      "type": "trust_item",
      "name": "Trust Item",
      "limit": 2,
      "settings": [
        {
          "type": "html",
          "id": "icon_svg",
          "label": "Icon (SVG)",
          "info": "Paste inline SVG code"
        },
        {
          "type": "text",
          "id": "text",
          "label": "Text",
          "default": "100% Bio-zertifiziert"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "DinVeda Product Hero",
      "blocks": [
        {
          "type": "trust_item",
          "settings": {
            "icon_svg": "<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z\" stroke=\"currentColor\" stroke-width=\"1.7\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>",
            "text": "100% Bio-zertifiziert"
          }
        },
        {
          "type": "trust_item",
          "settings": {
            "icon_svg": "<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z\" stroke=\"currentColor\" stroke-width=\"1.7\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/><polyline points=\"9 22 9 12 15 12 15 22\" stroke=\"currentColor\" stroke-width=\"1.7\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>",
            "text": "Made in Germany"
          }
        }
      ]
    }
  ]
}
{% endschema %}

